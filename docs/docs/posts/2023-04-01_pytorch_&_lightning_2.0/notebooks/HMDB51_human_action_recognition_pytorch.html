<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.302">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>John Pinto - HMDB51 - Human Action Recognition using Pytorch</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../../">
<link href="../../../../assets/images/favicon.png" rel="icon" type="image/png">
<script src="../../../../site_libs/cookie-consent/cookie-consent.js"></script>
<link href="../../../../site_libs/cookie-consent/cookie-consent.css" rel="stylesheet">
<script src="../../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="../../../../site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="../../../../site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-6DE2RCBFFM"></script>

<script type="text/plain" cookie-consent="tracking">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-6DE2RCBFFM', { 'anonymize_ip': true});
</script>

<script type="text/javascript" charset="UTF-8">
document.addEventListener('DOMContentLoaded', function () {
cookieconsent.run({
  "notice_banner_type":"simple",
  "consent_type":"implied",
  "palette":"light",
  "language":"en",
  "page_load_consent_levels":["strictly-necessary","functionality","tracking","targeting"],
  "notice_banner_reject_button_hide":false,
  "preferences_center_close_button_hide":false,
  "website_name":""
  });
});
</script> 
  
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script src="https://unpkg.com/@jupyter-widgets/html-manager@*/dist/embed-amd.js" crossorigin="anonymous"></script>


<link rel="stylesheet" href="../../../../styles.css">
<meta property="og:title" content="John Pinto - HMDB51 - Human Action Recognition using Pytorch">
<meta property="og:description" content="">
<meta property="og:image" content="https://johnppinto.github.io/blog/docs/posts/2023-04-01_pytorch_&amp;_lightning_2.0/notebooks/HMDB51_human_action_recognition_pytorch_files/figure-html/cell-11-output-1.png">
<meta property="og:site-name" content="John Pinto">
<meta property="og:image:height" content="1590">
<meta property="og:image:width" content="1570">
<meta name="twitter:title" content="John Pinto - HMDB51 - Human Action Recognition using Pytorch">
<meta name="twitter:description" content="">
<meta name="twitter:image" content="https://johnppinto.github.io/blog/docs/posts/2023-04-01_pytorch_&amp;_lightning_2.0/notebooks/HMDB51_human_action_recognition_pytorch_files/figure-html/cell-11-output-1.png">
<meta name="twitter:image-height" content="1590">
<meta name="twitter:image-width" content="1570">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../../../index.html">
    <span class="navbar-title">John Pinto</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../../blog.html" rel="" target="">
 <span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://johnppinto.github.io/" rel="" target="_blank">
 <span class="menu-text">Portfolio</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/JohnPPinto" rel="" target="_blank"><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/john-p-pinto/" rel="" target="_blank"><i class="bi bi-linkedin" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://medium.com/@pintojohn47" rel="" target="_blank"><i class="bi bi-medium" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/john77272002" rel="" target="_blank"><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../../../blog.xml" rel="" target="_blank"><i class="bi bi-rss" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">HMDB51 - Human Action Recognition using Pytorch</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="importing-libraries" class="level2">
<h2 class="anchored" data-anchor-id="importing-libraries">Importing Libraries</h2>
<div class="cell" data-tags="[]" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install <span class="op">-</span>U <span class="op">-</span>q <span class="op">-</span>r requirements.txt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>WARNING: Running pip as the 'root' user can result in broken permissions and conflicting behaviour with the system package manager. It is recommended to use a virtual environment instead: https://pip.pypa.io/warnings/venv</code></pre>
</div>
</div>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> shutil</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rarfile</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> gradio <span class="im">as</span> gr</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm.auto <span class="im">import</span> tqdm</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> timeit <span class="im">import</span> default_timer <span class="im">as</span> timer</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> Counter</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> cv2</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> Video, IFrame</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torchvision</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torchmetrics</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchinfo <span class="im">import</span> summary</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> Dataset, DataLoader, random_split</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchvision <span class="im">import</span> transforms, utils</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchvision.io <span class="im">import</span> read_video</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchvision.models.video <span class="im">import</span> mvit_v2_s, MViT_V2_S_Weights</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> lightning <span class="im">as</span> L</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lightning.fabric <span class="im">import</span> Fabric</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Torch version: </span><span class="sc">{</span>torch<span class="sc">.</span>__version__<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Torchvision version: </span><span class="sc">{</span>torchvision<span class="sc">.</span>__version__<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Lightning version: </span><span class="sc">{</span>L<span class="sc">.</span>__version__<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'GPU score: </span><span class="sc">{</span>torch<span class="sc">.</span>cuda<span class="sc">.</span>get_device_capability()<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Torch version: 2.0.0+cu117
Torchvision version: 0.15.1+cu117
Lightning version: 2.0.1
GPU score: (8, 6)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Setting seed for randomness</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> set_seed(seed: <span class="bu">int</span> <span class="op">=</span> <span class="dv">42</span>):</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    np.random.seed(seed)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    torch.manual_seed(seed)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    random.seed(seed)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>set_seed(<span class="dv">42</span>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="co"># setting the device</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>device <span class="op">=</span> torch.device(<span class="st">'cuda'</span> <span class="cf">if</span> torch.cuda.is_available() <span class="cf">else</span> <span class="st">'cpu'</span>)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>device</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>device(type='cuda')</code></pre>
</div>
</div>
</section>
<section id="downloading-the-dataset" class="level2">
<h2 class="anchored" data-anchor-id="downloading-the-dataset">Downloading the Dataset</h2>
<p>Downloading the data from the dataset origin.</p>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>DATA_URL <span class="op">=</span> <span class="st">'http://serre-lab.clps.brown.edu/wp-content/uploads/2013/10/hmdb51_org.rar'</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>RAW_DATA_PATH <span class="op">=</span> <span class="st">'raw_data'</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>DATA_PATH <span class="op">=</span> <span class="st">'data'</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>HMDB_DATA_PATH <span class="op">=</span> os.path.join(DATA_PATH, <span class="st">'HMDB51'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-tags="[]" data-execution_count="6">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> os.path.isfile(<span class="st">'hmdb51_org.rar'</span>):</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'[INFO] Data already exists!'</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'[INFO] Downloading data.'</span>)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> requests.get(DATA_URL)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(<span class="st">'hmdb51_org.rar'</span>, <span class="st">'wb'</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>        <span class="bu">file</span>.write(r.content)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>        <span class="bu">file</span>.close()</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'[INFO] Data is been downloaded!'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[INFO] Downloading data.
[INFO] Data is been downloaded!</code></pre>
</div>
</div>
<p>Extracting the data in the raw_data directory</p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> os.path.exists(RAW_DATA_PATH):</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'[INFO] Data path already exists!'</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'[INFO] Extracting data.'</span>)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    os.mkdir(RAW_DATA_PATH)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> rarfile.RarFile(<span class="st">'hmdb51_org.rar'</span>)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    r.extractall(RAW_DATA_PATH)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    r.close()</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'[INFO] Data extraction done!'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[INFO] Extracting data.
[INFO] Data extraction done!</code></pre>
</div>
</div>
<p>Extracting all the raw data in the data directory and deleting the raw data from the system..</p>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> os.path.exists(DATA_PATH):</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'[INFO] Data path already exists!'</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'[INFO] Extracting all the classes data.'</span>)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    os.mkdir(DATA_PATH)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> data <span class="kw">in</span> os.listdir(RAW_DATA_PATH):</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>        r <span class="op">=</span> rarfile.RarFile(os.path.join(RAW_DATA_PATH, data))</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>        r.extractall(DATA_PATH)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>        r.close()</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'[INFO] Data extraction done for: "</span><span class="sc">{</span>os<span class="sc">.</span>path<span class="sc">.</span>join(RAW_DATA_PATH, data)<span class="sc">}</span><span class="ss">"!'</span>)</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    os.remove(<span class="st">'hmdb51_org.rar'</span>)</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    shutil.rmtree(RAW_DATA_PATH)</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'</span><span class="ch">\n</span><span class="ss">[INFO] Deleted raw data.'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[INFO] Extracting all the classes data.
[INFO] Data extraction done for: "raw_data/clap.rar"!
[INFO] Data extraction done for: "raw_data/talk.rar"!
[INFO] Data extraction done for: "raw_data/smoke.rar"!
[INFO] Data extraction done for: "raw_data/draw_sword.rar"!
[INFO] Data extraction done for: "raw_data/flic_flac.rar"!
[INFO] Data extraction done for: "raw_data/dive.rar"!
[INFO] Data extraction done for: "raw_data/shoot_bow.rar"!
[INFO] Data extraction done for: "raw_data/drink.rar"!
[INFO] Data extraction done for: "raw_data/hug.rar"!
[INFO] Data extraction done for: "raw_data/pour.rar"!
[INFO] Data extraction done for: "raw_data/pushup.rar"!
[INFO] Data extraction done for: "raw_data/hit.rar"!
[INFO] Data extraction done for: "raw_data/wave.rar"!
[INFO] Data extraction done for: "raw_data/run.rar"!
[INFO] Data extraction done for: "raw_data/walk.rar"!
[INFO] Data extraction done for: "raw_data/fall_floor.rar"!
[INFO] Data extraction done for: "raw_data/ride_horse.rar"!
[INFO] Data extraction done for: "raw_data/turn.rar"!
[INFO] Data extraction done for: "raw_data/situp.rar"!
[INFO] Data extraction done for: "raw_data/jump.rar"!
[INFO] Data extraction done for: "raw_data/shoot_ball.rar"!
[INFO] Data extraction done for: "raw_data/dribble.rar"!
[INFO] Data extraction done for: "raw_data/sit.rar"!
[INFO] Data extraction done for: "raw_data/chew.rar"!
[INFO] Data extraction done for: "raw_data/pick.rar"!
[INFO] Data extraction done for: "raw_data/kick.rar"!
[INFO] Data extraction done for: "raw_data/eat.rar"!
[INFO] Data extraction done for: "raw_data/fencing.rar"!
[INFO] Data extraction done for: "raw_data/swing_baseball.rar"!
[INFO] Data extraction done for: "raw_data/stand.rar"!
[INFO] Data extraction done for: "raw_data/handstand.rar"!
[INFO] Data extraction done for: "raw_data/climb.rar"!
[INFO] Data extraction done for: "raw_data/kiss.rar"!
[INFO] Data extraction done for: "raw_data/kick_ball.rar"!
[INFO] Data extraction done for: "raw_data/push.rar"!
[INFO] Data extraction done for: "raw_data/throw.rar"!
[INFO] Data extraction done for: "raw_data/cartwheel.rar"!
[INFO] Data extraction done for: "raw_data/pullup.rar"!
[INFO] Data extraction done for: "raw_data/brush_hair.rar"!
[INFO] Data extraction done for: "raw_data/sword.rar"!
[INFO] Data extraction done for: "raw_data/climb_stairs.rar"!
[INFO] Data extraction done for: "raw_data/laugh.rar"!
[INFO] Data extraction done for: "raw_data/punch.rar"!
[INFO] Data extraction done for: "raw_data/ride_bike.rar"!
[INFO] Data extraction done for: "raw_data/sword_exercise.rar"!
[INFO] Data extraction done for: "raw_data/somersault.rar"!
[INFO] Data extraction done for: "raw_data/shoot_gun.rar"!
[INFO] Data extraction done for: "raw_data/catch.rar"!
[INFO] Data extraction done for: "raw_data/smile.rar"!
[INFO] Data extraction done for: "raw_data/golf.rar"!
[INFO] Data extraction done for: "raw_data/shake_hands.rar"!

[INFO] Deleted raw data.</code></pre>
</div>
</div>
<p>Checking some info on the data that is been extracted.</p>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> dirpath, dirnames, filenames <span class="kw">in</span> os.walk(DATA_PATH):</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'There are </span><span class="sc">{</span><span class="bu">len</span>(dirnames)<span class="sc">}</span><span class="ss"> directories and </span><span class="sc">{</span><span class="bu">len</span>(filenames)<span class="sc">}</span><span class="ss"> files in "</span><span class="sc">{</span>dirpath<span class="sc">}</span><span class="ss">".'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>There are 51 directories and 0 files in "data".
There are 0 directories and 143 files in "data/swing_baseball".
There are 0 directories and 232 files in "data/run".
There are 0 directories and 105 files in "data/situp".
There are 0 directories and 162 files in "data/shake_hands".
There are 0 directories and 107 files in "data/flic_flac".
There are 0 directories and 127 files in "data/hit".
There are 0 directories and 102 files in "data/kiss".
There are 0 directories and 120 files in "data/talk".
There are 0 directories and 164 files in "data/drink".
There are 0 directories and 104 files in "data/wave".
There are 0 directories and 140 files in "data/somersault".
There are 0 directories and 116 files in "data/push".
There are 0 directories and 116 files in "data/ride_horse".
There are 0 directories and 128 files in "data/kick_ball".
There are 0 directories and 105 files in "data/golf".
There are 0 directories and 112 files in "data/shoot_bow".
There are 0 directories and 116 files in "data/fencing".
There are 0 directories and 102 files in "data/smile".
There are 0 directories and 145 files in "data/dribble".
There are 0 directories and 154 files in "data/stand".
There are 0 directories and 130 files in "data/clap".
There are 0 directories and 548 files in "data/walk".
There are 0 directories and 102 files in "data/throw".
There are 0 directories and 151 files in "data/jump".
There are 0 directories and 103 files in "data/shoot_gun".
There are 0 directories and 131 files in "data/shoot_ball".
There are 0 directories and 102 files in "data/catch".
There are 0 directories and 103 files in "data/draw_sword".
There are 0 directories and 142 files in "data/sit".
There are 0 directories and 127 files in "data/sword_exercise".
There are 0 directories and 108 files in "data/climb".
There are 0 directories and 104 files in "data/pullup".
There are 0 directories and 126 files in "data/punch".
There are 0 directories and 103 files in "data/pushup".
There are 0 directories and 127 files in "data/sword".
There are 0 directories and 108 files in "data/eat".
There are 0 directories and 109 files in "data/chew".
There are 0 directories and 128 files in "data/laugh".
There are 0 directories and 103 files in "data/ride_bike".
There are 0 directories and 118 files in "data/hug".
There are 0 directories and 107 files in "data/cartwheel".
There are 0 directories and 106 files in "data/pick".
There are 0 directories and 130 files in "data/kick".
There are 0 directories and 113 files in "data/handstand".
There are 0 directories and 240 files in "data/turn".
There are 0 directories and 112 files in "data/climb_stairs".
There are 0 directories and 127 files in "data/dive".
There are 0 directories and 107 files in "data/brush_hair".
There are 0 directories and 106 files in "data/pour".
There are 0 directories and 109 files in "data/smoke".
There are 0 directories and 136 files in "data/fall_floor".</code></pre>
</div>
</div>
</section>
<section id="visualizing-the-dataset" class="level2">
<h2 class="anchored" data-anchor-id="visualizing-the-dataset">Visualizing the dataset</h2>
<p>Now that the data is downloaded, lets view the data with the labels.</p>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">20</span>, <span class="dv">20</span>))</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>CLASSES <span class="op">=</span> <span class="bu">sorted</span>(os.listdir(DATA_PATH))</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Selecting 20 random categories for visualization</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>random_range <span class="op">=</span> random.sample(<span class="bu">range</span>(<span class="bu">len</span>(CLASSES)), <span class="dv">20</span>)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, rand_i <span class="kw">in</span> <span class="bu">enumerate</span>(random_range, <span class="dv">1</span>):</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    class_name <span class="op">=</span> CLASSES[rand_i]</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Looking for the video files in the category and selecting it randomly</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    video_files_list <span class="op">=</span> os.listdir(os.path.join(DATA_PATH, class_name))</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    video_file_name <span class="op">=</span> random.choice(video_files_list)</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Reading the video file and displaying the first frame with label.</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    video_reader <span class="op">=</span> cv2.VideoCapture(os.path.join(DATA_PATH, class_name, video_file_name))</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    _, frame <span class="op">=</span> video_reader.read()</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    video_reader.release()</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>    rgb_frame <span class="op">=</span> cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>    cv2.putText(rgb_frame, class_name, (<span class="dv">10</span>, <span class="dv">30</span>), cv2.FONT_HERSHEY_SIMPLEX, <span class="dv">1</span>, (<span class="dv">255</span>, <span class="dv">255</span>, <span class="dv">255</span>), <span class="dv">2</span>)</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>    plt.subplot(<span class="dv">5</span>, <span class="dv">4</span>, i)</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="ss">f'Category: </span><span class="sc">{</span>class_name<span class="sc">}</span><span class="ss">,</span><span class="ch">\n</span><span class="ss">Shape: </span><span class="sc">{</span>rgb_frame<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>    plt.imshow(rgb_frame)</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>    plt.axis(<span class="va">False</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="HMDB51_human_action_recognition_pytorch_files/figure-html/cell-11-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="preprocessing-the-dataset" class="level2">
<h2 class="anchored" data-anchor-id="preprocessing-the-dataset">Preprocessing the Dataset</h2>
<p>Creating pytorch Dataset.</p>
<p>In this steps we will be creating a custom dataset class using the functionality provided by PyTorch. 1. Read the video file. 2. Extracting the frames after every distance for a max sequence length. 3. Assigning label index for all the classes. 4. Performing torchvision.transform on the video data. 5. Returning tuple of video and label data as a tensor.</p>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Defining variables</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>SEQUENCE_LENGTH <span class="op">=</span> <span class="dv">16</span> <span class="co"># Frames feeded to the model as a single sequence</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>NUM_CLASSES <span class="op">=</span> <span class="dv">20</span> <span class="co"># Selecting 20 classes from 51 classes</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Before creating the dataset, first lets clean it.<br> Here we will check whether the videos are readable and the frame count needs to be more than the Sequence Length frames.</p>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>files_list <span class="op">=</span> [os.path.join(DATA_PATH, <span class="bu">dir</span>, video) <span class="cf">for</span> <span class="bu">dir</span> <span class="kw">in</span> CLASSES <span class="cf">for</span> video <span class="kw">in</span> os.listdir(DATA_PATH <span class="op">+</span> <span class="st">"/"</span> <span class="op">+</span> <span class="bu">dir</span>)]</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>remove_file_list <span class="op">=</span> []</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> files_list:</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    vframes, _, _ <span class="op">=</span> read_video(filename<span class="op">=</span><span class="bu">file</span>, pts_unit<span class="op">=</span><span class="st">'sec'</span>, output_format<span class="op">=</span><span class="st">'TCHW'</span>)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(vframes) <span class="op">&lt;=</span> SEQUENCE_LENGTH:</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'File Name: </span><span class="sc">{</span><span class="bu">file</span><span class="sc">}</span><span class="ss"> and Total Frames Count: </span><span class="sc">{</span><span class="bu">len</span>(vframes)<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>        remove_file_list.append(<span class="bu">file</span>)</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>remove_file_list</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>[]</code></pre>
</div>
</div>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Deleting the video files</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">len</span>(remove_file_list) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> file_path <span class="kw">in</span> remove_file_list:</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>: </span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>            os.remove(path<span class="op">=</span>file_path)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f'File "</span><span class="sc">{</span>file_path<span class="sc">}</span><span class="ss">" is been deleted'</span>)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">FileNotFoundError</span>:</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">'File is missing or is been already deleted'</span>)</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'There are no files to delete.'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>There are no files to delete.</code></pre>
</div>
</div>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> HumanActionDataset(Dataset):</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="co">    A class to create a PyTorch dataset using the video files directory,</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co">    transforming the video data and returning the data and labels for every index.</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="co">        video_dir: str, A string containing the path for all the video categories or classes.</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="co">        seq_len: int(default: 20), A integer specifing the required total sequence frames.</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="co">        num_classes: int(default: 20), Selecting random classes and the max allowed is 51 classes for this dataset.</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="co">        transform: default: None, A torchvision transforms for applying multiple transformation on every frame.</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="co">        selected_frame, label: tuple, A tuple containing the video "TCHW" and label data in tensor format. </span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, video_dir: <span class="bu">str</span>, seq_len: <span class="bu">int</span>, num_classes: <span class="bu">int</span>, transform<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.video_dir <span class="op">=</span> video_dir</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.seq_len <span class="op">=</span> seq_len</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.num_classes <span class="op">=</span> num_classes</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.transform <span class="op">=</span> transform </span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Creating a list of all the video files path and classes.</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>        set_seed(seed<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.num_classes <span class="op">&gt;</span> <span class="dv">51</span>:</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.num_classes <span class="op">=</span> <span class="dv">51</span></span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.classes <span class="op">=</span> random.sample(<span class="bu">sorted</span>(os.listdir(video_dir)), k<span class="op">=</span><span class="va">self</span>.num_classes)</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.files_list <span class="op">=</span> [os.path.join(video_dir, <span class="bu">dir</span>, video) <span class="cf">for</span> <span class="bu">dir</span> <span class="kw">in</span> <span class="va">self</span>.classes <span class="cf">for</span> video <span class="kw">in</span> os.listdir(video_dir <span class="op">+</span> <span class="st">"/"</span> <span class="op">+</span> <span class="bu">dir</span>)]</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__len__</span>(<span class="va">self</span>):</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">len</span>(<span class="va">self</span>.files_list)</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__getitem__</span>(<span class="va">self</span>, index):</span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>        video_path <span class="op">=</span> <span class="va">self</span>.files_list[index]</span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Reading the video file</span></span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>        vframes, _, _ <span class="op">=</span> read_video(filename<span class="op">=</span>video_path, pts_unit<span class="op">=</span><span class="st">'sec'</span>, output_format<span class="op">=</span><span class="st">'TCHW'</span>)</span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>        vframes <span class="op">=</span> vframes.<span class="bu">type</span>(torch.float32)</span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a>        vframes_count <span class="op">=</span> <span class="bu">len</span>(vframes)</span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Selecting frames at certain interval</span></span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a>        skip_frames <span class="op">=</span> <span class="bu">max</span>(<span class="bu">int</span>(vframes_count<span class="op">/</span><span class="va">self</span>.seq_len), <span class="dv">1</span>)</span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a>        selected_frame <span class="op">=</span> vframes[<span class="dv">0</span>].unsqueeze(<span class="dv">0</span>)</span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Creating a new sequence of frames upto the defined sequence length.</span></span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="va">self</span>.seq_len):</span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a>            selected_frame <span class="op">=</span> torch.concat((selected_frame, vframes[i <span class="op">*</span> skip_frames].unsqueeze(<span class="dv">0</span>)))</span>
<span id="cb23-45"><a href="#cb23-45" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb23-46"><a href="#cb23-46" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Video label as per the classes list.</span></span>
<span id="cb23-47"><a href="#cb23-47" aria-hidden="true" tabindex="-1"></a>        label <span class="op">=</span> torch.tensor(<span class="va">self</span>.classes.index(video_path.split(<span class="st">'/'</span>)[<span class="dv">1</span>]))</span>
<span id="cb23-48"><a href="#cb23-48" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-49"><a href="#cb23-49" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Applying transformation to the frames</span></span>
<span id="cb23-50"><a href="#cb23-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.transform:</span>
<span id="cb23-51"><a href="#cb23-51" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">self</span>.transform(selected_frame), label</span>
<span id="cb23-52"><a href="#cb23-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb23-53"><a href="#cb23-53" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> selected_frame, label</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating the dataset</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>dataset <span class="op">=</span> HumanActionDataset(video_dir<span class="op">=</span>DATA_PATH, seq_len<span class="op">=</span>SEQUENCE_LENGTH, num_classes<span class="op">=</span>NUM_CLASSES)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Length of the dataset: </span><span class="sc">{</span><span class="bu">len</span>(dataset)<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Checking the dataset shape</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>frames, label <span class="op">=</span> dataset[<span class="dv">2000</span>]</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Video tensor(first frame):</span><span class="ch">\n</span><span class="sc">{</span>frames[<span class="dv">0</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">label tensor: </span><span class="sc">{</span>label<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Shape of the video tensor: </span><span class="sc">{</span>frames<span class="sc">.</span>shape<span class="sc">}</span><span class="ss"> and shape of the label: </span><span class="sc">{</span>label<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Length of the dataset: 2530
Video tensor(first frame):
tensor([[[ 0.,  0.,  0.,  ...,  0.,  0.,  0.],
         [ 0.,  0.,  0.,  ...,  1.,  1.,  1.],
         [ 2.,  2.,  0.,  ..., 11., 11., 11.],
         ...,
         [ 2.,  2.,  0.,  ..., 55., 55., 55.],
         [ 5.,  5.,  3.,  ..., 62., 62., 62.],
         [ 5.,  5.,  2.,  ..., 34., 34., 34.]],

        [[ 4.,  4.,  5.,  ...,  2.,  1.,  1.],
         [ 5.,  5.,  5.,  ...,  3.,  3.,  3.],
         [ 4.,  4.,  5.,  ..., 17., 17., 17.],
         ...,
         [ 2.,  2.,  2.,  ..., 41., 41., 41.],
         [ 0.,  0.,  1.,  ..., 49., 49., 49.],
         [ 0.,  0.,  0.,  ..., 21., 21., 21.]],

        [[ 3.,  3.,  4.,  ...,  2.,  1.,  1.],
         [ 4.,  4.,  4.,  ...,  3.,  3.,  3.],
         [ 1.,  1.,  1.,  ...,  8.,  8.,  8.],
         ...,
         [ 0.,  0.,  0.,  ..., 16., 14., 14.],
         [ 0.,  0.,  0.,  ..., 28., 28., 28.],
         [ 0.,  0.,  0.,  ...,  0.,  0.,  0.]]])
label tensor: 16
Shape of the video tensor: torch.Size([16, 3, 240, 320]) and shape of the label: torch.Size([])</code></pre>
</div>
</div>
</section>
<section id="creating-a-pretrained-model" class="level2">
<h2 class="anchored" data-anchor-id="creating-a-pretrained-model">Creating A Pretrained Model</h2>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_model(num_classes: <span class="bu">int</span>, device: torch.device, seed: <span class="bu">int</span> <span class="op">=</span> <span class="dv">42</span>):</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="co">    A function to create a model.</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="co">        num_classes: int, A integer for toal number of classes.</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="co">        device: torch.device, A torch device to set the tensors to cpu or cuda.</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="co">        seed: int(default: 42), A random seed value.</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns: </span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="co">        model: A feature extracted model for video classification.</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="co">        transforms: A torchvision transform is returned which was used in the pretrained model.    </span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Creating model, weights and transforms</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>    weights <span class="op">=</span> MViT_V2_S_Weights.DEFAULT</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>    transforms <span class="op">=</span> weights.transforms()</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> mvit_v2_s(weights<span class="op">=</span>weights)</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Freezing the model layers</span></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> params <span class="kw">in</span> model.parameters():</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>        params.requires_grad <span class="op">=</span> <span class="va">False</span></span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Changing the fully Conncected head layer</span></span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>    set_seed(seed)</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>    dropout_layer <span class="op">=</span> model.head[<span class="dv">0</span>]</span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>    in_features <span class="op">=</span> model.head[<span class="dv">1</span>].in_features</span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>    model.head <span class="op">=</span> torch.nn.Sequential(</span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>        dropout_layer,</span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>        torch.nn.Linear(in_features<span class="op">=</span>in_features, out_features<span class="op">=</span>num_classes, bias<span class="op">=</span><span class="va">True</span>, device<span class="op">=</span>device)</span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> model.to(device), transforms</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating the model and transforms using the function.</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>model, transforms <span class="op">=</span> create_model(num_classes<span class="op">=</span><span class="bu">len</span>(dataset.classes), device<span class="op">=</span>device)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>summary(model, </span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>        input_size<span class="op">=</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">16</span>, <span class="dv">224</span>, <span class="dv">224</span>),</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>        col_names<span class="op">=</span>[<span class="st">"input_size"</span>, <span class="st">"output_size"</span>, <span class="st">"num_params"</span>, <span class="st">"trainable"</span>],</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>        col_width<span class="op">=</span><span class="dv">20</span>,</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>        row_settings<span class="op">=</span>[<span class="st">"var_names"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/usr/local/lib/python3.9/dist-packages/torchinfo/torchinfo.py:477: UserWarning: TypedStorage is deprecated. It will be removed in the future and UntypedStorage will be the only storage class. This should only matter to you if you are using storages directly.  To access UntypedStorage directly, use tensor.untyped_storage() instead of tensor.storage()
  action_fn=lambda data: sys.getsizeof(data.storage()),
/usr/local/lib/python3.9/dist-packages/torch/storage.py:665: UserWarning: TypedStorage is deprecated. It will be removed in the future and UntypedStorage will be the only storage class. This should only matter to you if you are using storages directly.  To access UntypedStorage directly, use tensor.untyped_storage() instead of tensor.storage()
  return super().__sizeof__() + self.nbytes()</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>==================================================================================================================================
Layer (type (var_name))                            Input Shape          Output Shape         Param #              Trainable
==================================================================================================================================
MViT (MViT)                                        [1, 3, 16, 224, 224] [1, 20]              --                   Partial
Conv3d (conv_proj)                               [1, 3, 16, 224, 224] [1, 96, 8, 56, 56]   (42,432)             False
PositionalEncoding (pos_encoding)                [1, 25088, 96]       [1, 25089, 96]       (96)                 False
ModuleList (blocks)                              --                   --                   --                   False
    MultiscaleBlock (0)                         [1, 25089, 96]       [1, 25089, 96]       --                   False
        LayerNorm (norm1)                      [1, 25089, 96]       [1, 25089, 96]       (192)                False
        MultiscaleAttention (attn)             [1, 25089, 96]       [1, 25089, 96]       (68,352)             False
        StochasticDepth (stochastic_depth)     [1, 25089, 96]       [1, 25089, 96]       --                   --
        LayerNorm (norm2)                      [1, 25089, 96]       [1, 25089, 96]       (192)                False
        MLP (mlp)                              [1, 25089, 96]       [1, 25089, 96]       (74,208)             False
        StochasticDepth (stochastic_depth)     [1, 25089, 96]       [1, 25089, 96]       --                   --
    MultiscaleBlock (1)                         [1, 25089, 96]       [1, 6273, 192]       --                   False
        LayerNorm (norm1)                      [1, 25089, 96]       [1, 25089, 96]       (192)                False
        MultiscaleAttention (attn)             [1, 25089, 96]       [1, 6273, 192]       (113,280)            False
        Linear (project)                       [1, 25089, 96]       [1, 25089, 192]      (18,624)             False
        Pool (pool_skip)                       [1, 25089, 192]      [1, 6273, 192]       --                   --
        StochasticDepth (stochastic_depth)     [1, 6273, 192]       [1, 6273, 192]       --                   --
        LayerNorm (norm2)                      [1, 6273, 192]       [1, 6273, 192]       (384)                False
        MLP (mlp)                              [1, 6273, 192]       [1, 6273, 192]       (295,872)            False
        StochasticDepth (stochastic_depth)     [1, 6273, 192]       [1, 6273, 192]       --                   --
    MultiscaleBlock (2)                         [1, 6273, 192]       [1, 6273, 192]       --                   False
        LayerNorm (norm1)                      [1, 6273, 192]       [1, 6273, 192]       (384)                False
        MultiscaleAttention (attn)             [1, 6273, 192]       [1, 6273, 192]       (168,576)            False
        StochasticDepth (stochastic_depth)     [1, 6273, 192]       [1, 6273, 192]       --                   --
        LayerNorm (norm2)                      [1, 6273, 192]       [1, 6273, 192]       (384)                False
        MLP (mlp)                              [1, 6273, 192]       [1, 6273, 192]       (295,872)            False
        StochasticDepth (stochastic_depth)     [1, 6273, 192]       [1, 6273, 192]       --                   --
    MultiscaleBlock (3)                         [1, 6273, 192]       [1, 1569, 384]       --                   False
        LayerNorm (norm1)                      [1, 6273, 192]       [1, 6273, 192]       (384)                False
        MultiscaleAttention (attn)             [1, 6273, 192]       [1, 1569, 384]       (385,152)            False
        Linear (project)                       [1, 6273, 192]       [1, 6273, 384]       (74,112)             False
        Pool (pool_skip)                       [1, 6273, 384]       [1, 1569, 384]       --                   --
        StochasticDepth (stochastic_depth)     [1, 1569, 384]       [1, 1569, 384]       --                   --
        LayerNorm (norm2)                      [1, 1569, 384]       [1, 1569, 384]       (768)                False
        MLP (mlp)                              [1, 1569, 384]       [1, 1569, 384]       (1,181,568)          False
        StochasticDepth (stochastic_depth)     [1, 1569, 384]       [1, 1569, 384]       --                   --
    MultiscaleBlock (4)                         [1, 1569, 384]       [1, 1569, 384]       --                   False
        LayerNorm (norm1)                      [1, 1569, 384]       [1, 1569, 384]       (768)                False
        MultiscaleAttention (attn)             [1, 1569, 384]       [1, 1569, 384]       (606,336)            False
        StochasticDepth (stochastic_depth)     [1, 1569, 384]       [1, 1569, 384]       --                   --
        LayerNorm (norm2)                      [1, 1569, 384]       [1, 1569, 384]       (768)                False
        MLP (mlp)                              [1, 1569, 384]       [1, 1569, 384]       (1,181,568)          False
        StochasticDepth (stochastic_depth)     [1, 1569, 384]       [1, 1569, 384]       --                   --
    MultiscaleBlock (5)                         [1, 1569, 384]       [1, 1569, 384]       --                   False
        LayerNorm (norm1)                      [1, 1569, 384]       [1, 1569, 384]       (768)                False
        MultiscaleAttention (attn)             [1, 1569, 384]       [1, 1569, 384]       (606,336)            False
        StochasticDepth (stochastic_depth)     [1, 1569, 384]       [1, 1569, 384]       --                   --
        LayerNorm (norm2)                      [1, 1569, 384]       [1, 1569, 384]       (768)                False
        MLP (mlp)                              [1, 1569, 384]       [1, 1569, 384]       (1,181,568)          False
        StochasticDepth (stochastic_depth)     [1, 1569, 384]       [1, 1569, 384]       --                   --
    MultiscaleBlock (6)                         [1, 1569, 384]       [1, 1569, 384]       --                   False
        LayerNorm (norm1)                      [1, 1569, 384]       [1, 1569, 384]       (768)                False
        MultiscaleAttention (attn)             [1, 1569, 384]       [1, 1569, 384]       (606,336)            False
        StochasticDepth (stochastic_depth)     [1, 1569, 384]       [1, 1569, 384]       --                   --
        LayerNorm (norm2)                      [1, 1569, 384]       [1, 1569, 384]       (768)                False
        MLP (mlp)                              [1, 1569, 384]       [1, 1569, 384]       (1,181,568)          False
        StochasticDepth (stochastic_depth)     [1, 1569, 384]       [1, 1569, 384]       --                   --
    MultiscaleBlock (7)                         [1, 1569, 384]       [1, 1569, 384]       --                   False
        LayerNorm (norm1)                      [1, 1569, 384]       [1, 1569, 384]       (768)                False
        MultiscaleAttention (attn)             [1, 1569, 384]       [1, 1569, 384]       (606,336)            False
        StochasticDepth (stochastic_depth)     [1, 1569, 384]       [1, 1569, 384]       --                   --
        LayerNorm (norm2)                      [1, 1569, 384]       [1, 1569, 384]       (768)                False
        MLP (mlp)                              [1, 1569, 384]       [1, 1569, 384]       (1,181,568)          False
        StochasticDepth (stochastic_depth)     [1, 1569, 384]       [1, 1569, 384]       --                   --
    MultiscaleBlock (8)                         [1, 1569, 384]       [1, 1569, 384]       --                   False
        LayerNorm (norm1)                      [1, 1569, 384]       [1, 1569, 384]       (768)                False
        MultiscaleAttention (attn)             [1, 1569, 384]       [1, 1569, 384]       (606,336)            False
        StochasticDepth (stochastic_depth)     [1, 1569, 384]       [1, 1569, 384]       --                   --
        LayerNorm (norm2)                      [1, 1569, 384]       [1, 1569, 384]       (768)                False
        MLP (mlp)                              [1, 1569, 384]       [1, 1569, 384]       (1,181,568)          False
        StochasticDepth (stochastic_depth)     [1, 1569, 384]       [1, 1569, 384]       --                   --
    MultiscaleBlock (9)                         [1, 1569, 384]       [1, 1569, 384]       --                   False
        LayerNorm (norm1)                      [1, 1569, 384]       [1, 1569, 384]       (768)                False
        MultiscaleAttention (attn)             [1, 1569, 384]       [1, 1569, 384]       (606,336)            False
        StochasticDepth (stochastic_depth)     [1, 1569, 384]       [1, 1569, 384]       --                   --
        LayerNorm (norm2)                      [1, 1569, 384]       [1, 1569, 384]       (768)                False
        MLP (mlp)                              [1, 1569, 384]       [1, 1569, 384]       (1,181,568)          False
        StochasticDepth (stochastic_depth)     [1, 1569, 384]       [1, 1569, 384]       --                   --
    MultiscaleBlock (10)                        [1, 1569, 384]       [1, 1569, 384]       --                   False
        LayerNorm (norm1)                      [1, 1569, 384]       [1, 1569, 384]       (768)                False
        MultiscaleAttention (attn)             [1, 1569, 384]       [1, 1569, 384]       (606,336)            False
        StochasticDepth (stochastic_depth)     [1, 1569, 384]       [1, 1569, 384]       --                   --
        LayerNorm (norm2)                      [1, 1569, 384]       [1, 1569, 384]       (768)                False
        MLP (mlp)                              [1, 1569, 384]       [1, 1569, 384]       (1,181,568)          False
        StochasticDepth (stochastic_depth)     [1, 1569, 384]       [1, 1569, 384]       --                   --
    MultiscaleBlock (11)                        [1, 1569, 384]       [1, 1569, 384]       --                   False
        LayerNorm (norm1)                      [1, 1569, 384]       [1, 1569, 384]       (768)                False
        MultiscaleAttention (attn)             [1, 1569, 384]       [1, 1569, 384]       (606,336)            False
        StochasticDepth (stochastic_depth)     [1, 1569, 384]       [1, 1569, 384]       --                   --
        LayerNorm (norm2)                      [1, 1569, 384]       [1, 1569, 384]       (768)                False
        MLP (mlp)                              [1, 1569, 384]       [1, 1569, 384]       (1,181,568)          False
        StochasticDepth (stochastic_depth)     [1, 1569, 384]       [1, 1569, 384]       --                   --
    MultiscaleBlock (12)                        [1, 1569, 384]       [1, 1569, 384]       --                   False
        LayerNorm (norm1)                      [1, 1569, 384]       [1, 1569, 384]       (768)                False
        MultiscaleAttention (attn)             [1, 1569, 384]       [1, 1569, 384]       (606,336)            False
        StochasticDepth (stochastic_depth)     [1, 1569, 384]       [1, 1569, 384]       --                   --
        LayerNorm (norm2)                      [1, 1569, 384]       [1, 1569, 384]       (768)                False
        MLP (mlp)                              [1, 1569, 384]       [1, 1569, 384]       (1,181,568)          False
        StochasticDepth (stochastic_depth)     [1, 1569, 384]       [1, 1569, 384]       --                   --
    MultiscaleBlock (13)                        [1, 1569, 384]       [1, 1569, 384]       --                   False
        LayerNorm (norm1)                      [1, 1569, 384]       [1, 1569, 384]       (768)                False
        MultiscaleAttention (attn)             [1, 1569, 384]       [1, 1569, 384]       (606,336)            False
        StochasticDepth (stochastic_depth)     [1, 1569, 384]       [1, 1569, 384]       --                   --
        LayerNorm (norm2)                      [1, 1569, 384]       [1, 1569, 384]       (768)                False
        MLP (mlp)                              [1, 1569, 384]       [1, 1569, 384]       (1,181,568)          False
        StochasticDepth (stochastic_depth)     [1, 1569, 384]       [1, 1569, 384]       --                   --
    MultiscaleBlock (14)                        [1, 1569, 384]       [1, 393, 768]        --                   False
        LayerNorm (norm1)                      [1, 1569, 384]       [1, 1569, 384]       (768)                False
        MultiscaleAttention (attn)             [1, 1569, 384]       [1, 393, 768]        (1,492,608)          False
        Linear (project)                       [1, 1569, 384]       [1, 1569, 768]       (295,680)            False
        Pool (pool_skip)                       [1, 1569, 768]       [1, 393, 768]        --                   --
        StochasticDepth (stochastic_depth)     [1, 393, 768]        [1, 393, 768]        --                   --
        LayerNorm (norm2)                      [1, 393, 768]        [1, 393, 768]        (1,536)              False
        MLP (mlp)                              [1, 393, 768]        [1, 393, 768]        (4,722,432)          False
        StochasticDepth (stochastic_depth)     [1, 393, 768]        [1, 393, 768]        --                   --
    MultiscaleBlock (15)                        [1, 393, 768]        [1, 393, 768]        --                   False
        LayerNorm (norm1)                      [1, 393, 768]        [1, 393, 768]        (1,536)              False
        MultiscaleAttention (attn)             [1, 393, 768]        [1, 393, 768]        (2,374,656)          False
        StochasticDepth (stochastic_depth)     [1, 393, 768]        [1, 393, 768]        --                   --
        LayerNorm (norm2)                      [1, 393, 768]        [1, 393, 768]        (1,536)              False
        MLP (mlp)                              [1, 393, 768]        [1, 393, 768]        (4,722,432)          False
        StochasticDepth (stochastic_depth)     [1, 393, 768]        [1, 393, 768]        --                   --
LayerNorm (norm)                                 [1, 393, 768]        [1, 393, 768]        (1,536)              False
Sequential (head)                                [1, 768]             [1, 20]              --                   True
    Dropout (0)                                 [1, 768]             [1, 768]             --                   --
    Linear (1)                                  [1, 768]             [1, 20]              15,380               True
==================================================================================================================================
Total params: 34,245,524
Trainable params: 15,380
Non-trainable params: 34,230,144
Total mult-adds (G): 1.64
==================================================================================================================================
Input size (MB): 9.63
Forward/backward pass size (MB): 1658.93
Params size (MB): 136.46
Estimated Total Size (MB): 1805.02
==================================================================================================================================</code></pre>
</div>
</div>
<div class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Checking the model transforms and applying it on the dataset</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Pretrained Model Transforms:</span><span class="ch">\n</span><span class="sc">{</span>transforms<span class="sc">}</span><span class="ch">\n</span><span class="ss">'</span>)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>dataset <span class="op">=</span> HumanActionDataset(video_dir<span class="op">=</span>DATA_PATH, seq_len<span class="op">=</span>SEQUENCE_LENGTH, num_classes<span class="op">=</span>NUM_CLASSES, transform<span class="op">=</span>transforms)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Length of the dataset: </span><span class="sc">{</span><span class="bu">len</span>(dataset)<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Checking the dataset and shape</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>frames, label <span class="op">=</span> dataset[<span class="dv">2000</span>]</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Video tensor(first frame):</span><span class="ch">\n</span><span class="sc">{</span>frames[<span class="dv">0</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">label tensor: </span><span class="sc">{</span>label<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Shape of the video tensor: </span><span class="sc">{</span>frames<span class="sc">.</span>shape<span class="sc">}</span><span class="ss"> and shape of the label: </span><span class="sc">{</span>label<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Pretrained Model Transforms:
VideoClassification(
    crop_size=[224, 224]
    resize_size=[256]
    mean=[0.45, 0.45, 0.45]
    std=[0.225, 0.225, 0.225]
    interpolation=InterpolationMode.BILINEAR
)

Length of the dataset: 2530
Video tensor(first frame):
tensor([[[ 2.4604e+02,  2.3502e+02,  2.2911e+02,  ...,  2.8675e+02,
           2.8675e+02,  2.8684e+02],
         [ 2.3070e+02,  2.2561e+02,  2.1813e+02,  ...,  3.1508e+02,
           3.1508e+02,  3.1508e+02],
         [ 2.3060e+02,  2.2712e+02,  2.1802e+02,  ...,  3.1425e+02,
           3.1425e+02,  3.1425e+02],
         ...,
         [ 3.2401e+00,  2.9817e+00, -2.0000e+00,  ...,  1.6333e+02,
           1.2992e+02,  9.1900e+01],
         [-1.5833e+00, -1.7232e+00, -2.0000e+00,  ...,  4.4867e+02,
           3.7443e+02,  2.8330e+02],
         [ 2.4444e+00,  9.5210e-01, -2.0000e+00,  ...,  6.6754e+02,
           6.3805e+02,  5.6134e+02]],

        [[ 2.2467e+02,  2.2616e+02,  2.2911e+02,  ...,  3.0883e+02,
           3.0883e+02,  3.0902e+02],
         [ 2.2869e+02,  2.2478e+02,  2.1813e+02,  ...,  3.1314e+02,
           3.1314e+02,  3.1581e+02],
         [ 2.3060e+02,  2.2712e+02,  2.1802e+02,  ...,  3.1356e+02,
           3.1356e+02,  3.1402e+02],
         ...,
         [ 9.1056e+00,  6.2105e+00, -2.0000e+00,  ...,  9.9700e+01,
           7.6676e+01,  2.8844e+01],
         [ 1.9746e+01,  1.7561e+01, -1.1667e+00,  ...,  2.1729e+02,
           1.6955e+02,  1.1592e+02],
         [ 6.6111e+00,  6.6111e+00,  6.6111e+00,  ...,  5.4941e+02,
           5.2508e+02,  4.3940e+02]],

        [[-2.0000e+00,  5.3684e+00,  2.1125e+01,  ...,  3.2244e+02,
           3.1922e+02,  3.2077e+02],
         [-3.9952e-01,  4.0798e+00,  9.3575e+00,  ...,  3.2330e+02,
           3.1922e+02,  3.1025e+02],
         [ 2.0259e+00,  2.6776e+00,  5.3857e+00,  ...,  3.3464e+02,
           3.3047e+02,  3.1790e+02],
         ...,
         [ 1.7578e+02,  1.7578e+02,  1.7719e+02,  ...,  2.3105e+02,
           2.2658e+02,  2.1946e+02],
         [ 1.7803e+02,  1.7884e+02,  1.8227e+02,  ...,  2.3562e+02,
           2.2931e+02,  2.2306e+02],
         [ 1.9990e+02,  2.0851e+02,  2.2140e+02,  ...,  2.2817e+02,
           2.1964e+02,  2.2187e+02]],

        ...,

        [[ 4.2491e+02,  4.3142e+02,  4.2619e+02,  ...,  1.5639e+01,
           1.5639e+01,  1.5639e+01],
         [ 4.0218e+02,  4.0793e+02,  4.1056e+02,  ...,  6.0095e+00,
           7.7222e+00,  2.3716e+00],
         [ 4.0126e+02,  4.0792e+02,  4.0992e+02,  ...,  8.7490e+00,
           1.0639e+01,  2.2439e+00],
         ...,
         [ 1.2787e+02,  1.2839e+02,  1.3253e+02,  ...,  9.5269e-01,
           1.7500e+00,  1.7500e+00],
         [ 1.3349e+02,  1.2883e+02,  1.3904e+02,  ..., -2.0000e+00,
          -2.0000e+00, -2.0000e+00],
         [ 1.3694e+02,  1.3320e+02,  1.3960e+02,  ..., -2.0000e+00,
          -2.0000e+00, -2.0000e+00]],

        [[ 4.5630e+02,  4.6579e+02,  4.6640e+02,  ..., -2.0000e+00,
          -2.0000e+00, -2.0000e+00],
         [ 4.3329e+02,  4.3661e+02,  4.3776e+02,  ...,  1.1714e+00,
          -8.9558e-01, -2.0000e+00],
         [ 4.4439e+02,  4.4481e+02,  4.4500e+02,  ...,  1.4995e+00,
          -7.8133e-01, -2.0000e+00],
         ...,
         [ 1.4467e+02,  1.5315e+02,  1.7425e+02,  ..., -2.0000e+00,
          -1.4960e+00, -1.3056e+00],
         [ 1.4625e+02,  1.5174e+02,  1.6260e+02,  ..., -2.0000e+00,
           9.2336e-01,  2.0278e+00],
         [ 1.6148e+02,  1.6227e+02,  1.5224e+02,  ..., -2.0000e+00,
          -2.0000e+00, -2.0000e+00]],

        [[ 4.2527e+02,  4.4359e+02,  4.6669e+02,  ..., -2.0000e+00,
          -2.0000e+00, -2.0000e+00],
         [ 4.3037e+02,  4.3994e+02,  4.5392e+02,  ...,  2.0278e+00,
          -8.9558e-01, -2.0000e+00],
         [ 4.4064e+02,  4.4451e+02,  4.5152e+02,  ...,  2.4444e+00,
          -7.8133e-01,  4.9081e-01],
         ...,
         [ 1.4709e+02,  1.5459e+02,  1.5781e+02,  ..., -2.0000e+00,
          -1.4960e+00, -1.7668e+00],
         [ 1.4016e+02,  1.5057e+02,  1.5565e+02,  ..., -1.5833e+00,
           1.3400e+00,  4.5890e-02],
         [ 1.3139e+02,  1.3590e+02,  1.4467e+02,  ...,  2.4444e+00,
           2.4444e+00,  5.3965e+00]]])
label tensor: 16
Shape of the video tensor: torch.Size([3, 16, 224, 224]) and shape of the label: torch.Size([])</code></pre>
</div>
</div>
</section>
<section id="creating-dataloaders" class="level2">
<h2 class="anchored" data-anchor-id="creating-dataloaders">Creating DataLoaders</h2>
<div class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Spliting the dataset in train and test dataset for ratio of 75:25.</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>dataset <span class="op">=</span> HumanActionDataset(video_dir<span class="op">=</span>DATA_PATH, </span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>                             seq_len<span class="op">=</span>SEQUENCE_LENGTH,</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>                             num_classes<span class="op">=</span>NUM_CLASSES,</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>                             transform<span class="op">=</span>transforms)</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>train_dataset, test_dataset <span class="op">=</span> random_split(dataset<span class="op">=</span>dataset,</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>                                           lengths<span class="op">=</span>[<span class="fl">0.75</span>, <span class="fl">0.25</span>], </span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>                                           generator<span class="op">=</span>torch.Generator().manual_seed(<span class="dv">42</span>))</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Train Dataset Length: </span><span class="sc">{</span><span class="bu">len</span>(train_dataset)<span class="sc">}</span><span class="ss"> and Test Dataset length: </span><span class="sc">{</span><span class="bu">len</span>(test_dataset)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Train Dataset Length: 1898 and Test Dataset length: 632</code></pre>
</div>
</div>
<div class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating train and test dataloaders.</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_dataloaders(dataset, batch, shuffle, workers):</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="co">    A function to create pytorch dataloaders.</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="co">        dataset: A pytorch dataset.</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="co">        batch: A integer for batch size.</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a><span class="co">        shuffle: A boolean for shuffling the data.</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a><span class="co">        workers: A integer to set the workers in dataloaders.</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns: dataloader.</span></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>    dataloader <span class="op">=</span> DataLoader(dataset<span class="op">=</span>dataset, </span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>                            batch_size<span class="op">=</span>batch, </span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>                            shuffle<span class="op">=</span>shuffle, </span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>                            num_workers<span class="op">=</span>workers,</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>                            pin_memory<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>                            drop_last<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'Dataloaders Length: </span><span class="sc">{</span><span class="bu">len</span>(dataloader)<span class="sc">}</span><span class="ss"> for a batch size of: </span><span class="sc">{</span>batch<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> dataloader</span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>set_seed(<span class="dv">42</span>)</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>BATCH_SIZE <span class="op">=</span> <span class="dv">16</span></span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>WORKERS <span class="op">=</span> os.cpu_count()</span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>train_dataloader <span class="op">=</span> create_dataloaders(dataset<span class="op">=</span>train_dataset, batch<span class="op">=</span>BATCH_SIZE, shuffle<span class="op">=</span><span class="va">True</span>, workers<span class="op">=</span>WORKERS)</span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>test_dataloader <span class="op">=</span> create_dataloaders(dataset<span class="op">=</span>test_dataset, batch<span class="op">=</span>BATCH_SIZE, shuffle<span class="op">=</span><span class="va">False</span>, workers<span class="op">=</span>WORKERS)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Dataloaders Length: 118 for a batch size of: 16
Dataloaders Length: 39 for a batch size of: 16</code></pre>
</div>
</div>
<p><strong>Label Distribution and Zero Rule Benchmark</strong></p>
<div class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>train_counter <span class="op">=</span> Counter()</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> frames, labels <span class="kw">in</span> train_dataloader:</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>    train_counter.update(labels.tolist())</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Training Dataset Distribution:</span><span class="ch">\n</span><span class="st">'</span>, <span class="bu">sorted</span>(train_counter.items()))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Training Dataset Distribution:
 [(0, 78), (1, 92), (2, 83), (3, 79), (4, 94), (5, 72), (6, 77), (7, 79), (8, 85), (9, 103), (10, 90), (11, 106), (12, 88), (13, 78), (14, 180), (15, 70), (16, 87), (17, 100), (18, 171), (19, 76)]</code></pre>
</div>
</div>
<div class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>test_counter <span class="op">=</span> Counter()</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> frames, labels <span class="kw">in</span> test_dataloader:</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    test_counter.update(labels.tolist())</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Testing Dataset Distribution:</span><span class="ch">\n</span><span class="st">'</span>, <span class="bu">sorted</span>(test_counter.items()))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Testing Dataset Distribution:
 [(0, 30), (1, 32), (2, 24), (3, 23), (4, 29), (5, 32), (6, 30), (7, 24), (8, 27), (9, 27), (10, 17), (11, 35), (12, 37), (13, 24), (14, 58), (15, 33), (16, 29), (17, 26), (18, 60), (19, 27)]</code></pre>
</div>
</div>
<div class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Zero Rule Benchmark</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>major_class <span class="op">=</span> test_counter.most_common(<span class="dv">1</span>)[<span class="dv">0</span>]</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'The Major class in Testing DataLoader is: Class Name: </span><span class="sc">{</span>CLASSES[major_class[<span class="dv">0</span>]]<span class="sc">}</span><span class="ss">, Class Index: </span><span class="sc">{</span>major_class[<span class="dv">0</span>]<span class="sc">}</span><span class="ss"> and Total Number of Data: </span><span class="sc">{</span>major_class[<span class="dv">1</span>]<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>zero_rule_acc <span class="op">=</span> (major_class[<span class="dv">1</span>] <span class="op">/</span> <span class="bu">sum</span>(test_counter.values())) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Zero Rule Basline Benchmark Accuracy for predicting the major class: </span><span class="sc">{</span>zero_rule_acc<span class="sc">:.2f}</span><span class="ss">%'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The Major class in Testing DataLoader is: Class Name: hug, Class Index: 18 and Total Number of Data: 60
Zero Rule Basline Benchmark Accuracy for predicting the major class: 9.62%</code></pre>
</div>
</div>
</section>
<section id="pytorch---model-training-and-testing" class="level2">
<h2 class="anchored" data-anchor-id="pytorch---model-training-and-testing">PyTorch - Model Training and Testing</h2>
<div class="cell" data-execution_count="54">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_step(model, dataloader, loss_fn, optimizer, device, num_classes):</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Trains a pytorch model by going into train mode and applying forward pass,</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="co">    loss calculation and optimizer step.</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="co">        model: A pytorch model for training.</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a><span class="co">        dataloader: A pytorch dataloader for training.</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a><span class="co">        loss_fn: A pytorch loss to calculate the model's prediction loss.</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a><span class="co">        optimizer: A pytorch optimizer to minimize the loss function.</span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a><span class="co">        device: A torch device to allocate tensors on 'cpu' or 'cuda'.</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a><span class="co">        num_classes: A integer that indicates total number of classes in the dataset.</span></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns: A tuple of training loss and training accuracy.</span></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Model on training mode</span></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>    model.train()</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Setting train loss and accuracy </span></span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>    train_loss <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>    train_acc <span class="op">=</span> torchmetrics.Accuracy(task<span class="op">=</span><span class="st">'multiclass'</span>, num_classes<span class="op">=</span>num_classes).to(device)</span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Looping the dataloaders</span></span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> batch, (X, y) <span class="kw">in</span> tqdm(<span class="bu">enumerate</span>(dataloader), desc<span class="op">=</span><span class="st">'Model Training'</span>, total<span class="op">=</span><span class="bu">len</span>(dataloader), unit<span class="op">=</span><span class="st">'batch'</span>):</span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a>        X, y <span class="op">=</span> X.to(device), y.to(device)</span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 5 step to train a model</span></span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a>        y_pred <span class="op">=</span> model(X) <span class="co"># 1. Forward pass</span></span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a>        loss <span class="op">=</span> loss_fn(y_pred, y) <span class="co"># 2. Calculate loss</span></span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a>        train_loss <span class="op">+=</span> loss.item() </span>
<span id="cb43-32"><a href="#cb43-32" aria-hidden="true" tabindex="-1"></a>        optimizer.zero_grad() <span class="co"># 3. Initiate optimizer</span></span>
<span id="cb43-33"><a href="#cb43-33" aria-hidden="true" tabindex="-1"></a>        loss.backward() <span class="co"># 4. Backward pass</span></span>
<span id="cb43-34"><a href="#cb43-34" aria-hidden="true" tabindex="-1"></a>        optimizer.step() <span class="co"># 5. Updating the model parameters</span></span>
<span id="cb43-35"><a href="#cb43-35" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb43-36"><a href="#cb43-36" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculating the training accuracy</span></span>
<span id="cb43-37"><a href="#cb43-37" aria-hidden="true" tabindex="-1"></a>        y_pred_labels <span class="op">=</span> torch.argmax(torch.softmax(y_pred, dim<span class="op">=</span><span class="dv">1</span>), dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb43-38"><a href="#cb43-38" aria-hidden="true" tabindex="-1"></a>        train_acc.update(y_pred_labels, y)</span>
<span id="cb43-39"><a href="#cb43-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-40"><a href="#cb43-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Averaging the loss and accuracy</span></span>
<span id="cb43-41"><a href="#cb43-41" aria-hidden="true" tabindex="-1"></a>    train_loss <span class="op">=</span> train_loss <span class="op">/</span> <span class="bu">len</span>(dataloader)</span>
<span id="cb43-42"><a href="#cb43-42" aria-hidden="true" tabindex="-1"></a>    train_acc <span class="op">=</span> train_acc.compute()</span>
<span id="cb43-43"><a href="#cb43-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> train_loss, train_acc</span>
<span id="cb43-44"><a href="#cb43-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-45"><a href="#cb43-45" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_step(model, dataloader, loss_fn, device, num_classes):</span>
<span id="cb43-46"><a href="#cb43-46" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb43-47"><a href="#cb43-47" aria-hidden="true" tabindex="-1"></a><span class="co">    Test a pytorch model by going into eval mode and applying forward pass,</span></span>
<span id="cb43-48"><a href="#cb43-48" aria-hidden="true" tabindex="-1"></a><span class="co">    and loss calculation.</span></span>
<span id="cb43-49"><a href="#cb43-49" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb43-50"><a href="#cb43-50" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb43-51"><a href="#cb43-51" aria-hidden="true" tabindex="-1"></a><span class="co">        model: A pytorch model for testing.</span></span>
<span id="cb43-52"><a href="#cb43-52" aria-hidden="true" tabindex="-1"></a><span class="co">        dataloader: A pytorch dataloader for testing.</span></span>
<span id="cb43-53"><a href="#cb43-53" aria-hidden="true" tabindex="-1"></a><span class="co">        loss_fn: A pytorch loss to calculate the model's prediction loss.</span></span>
<span id="cb43-54"><a href="#cb43-54" aria-hidden="true" tabindex="-1"></a><span class="co">        device: A torch device to allocate tensors on 'cpu' or 'cuda'.</span></span>
<span id="cb43-55"><a href="#cb43-55" aria-hidden="true" tabindex="-1"></a><span class="co">        num_classes: A integer that indicates total number of classes in the dataset.</span></span>
<span id="cb43-56"><a href="#cb43-56" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb43-57"><a href="#cb43-57" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns: A tuple of testing loss and testing accuracy.</span></span>
<span id="cb43-58"><a href="#cb43-58" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb43-59"><a href="#cb43-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Model on evaluation mode</span></span>
<span id="cb43-60"><a href="#cb43-60" aria-hidden="true" tabindex="-1"></a>    model.<span class="bu">eval</span>()</span>
<span id="cb43-61"><a href="#cb43-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-62"><a href="#cb43-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Setting train loss and accuracy </span></span>
<span id="cb43-63"><a href="#cb43-63" aria-hidden="true" tabindex="-1"></a>    test_loss <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb43-64"><a href="#cb43-64" aria-hidden="true" tabindex="-1"></a>    test_acc <span class="op">=</span> torchmetrics.Accuracy(task<span class="op">=</span><span class="st">'multiclass'</span>, num_classes<span class="op">=</span>num_classes).to(device)</span>
<span id="cb43-65"><a href="#cb43-65" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-66"><a href="#cb43-66" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Using inference mode</span></span>
<span id="cb43-67"><a href="#cb43-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> torch.no_grad():</span>
<span id="cb43-68"><a href="#cb43-68" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Looping the dataloaders</span></span>
<span id="cb43-69"><a href="#cb43-69" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> batch, (X, y) <span class="kw">in</span> tqdm(<span class="bu">enumerate</span>(dataloader), desc<span class="op">=</span><span class="st">'Model Evaluation'</span>, total<span class="op">=</span><span class="bu">len</span>(dataloader), unit<span class="op">=</span><span class="st">'batch'</span>):</span>
<span id="cb43-70"><a href="#cb43-70" aria-hidden="true" tabindex="-1"></a>            X, y <span class="op">=</span> X.to(device), y.to(device)</span>
<span id="cb43-71"><a href="#cb43-71" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb43-72"><a href="#cb43-72" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Forward pass</span></span>
<span id="cb43-73"><a href="#cb43-73" aria-hidden="true" tabindex="-1"></a>            y_pred <span class="op">=</span> model(X)</span>
<span id="cb43-74"><a href="#cb43-74" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb43-75"><a href="#cb43-75" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Calculate loss</span></span>
<span id="cb43-76"><a href="#cb43-76" aria-hidden="true" tabindex="-1"></a>            loss <span class="op">=</span> loss_fn(y_pred, y)</span>
<span id="cb43-77"><a href="#cb43-77" aria-hidden="true" tabindex="-1"></a>            test_loss <span class="op">+=</span> loss.item()</span>
<span id="cb43-78"><a href="#cb43-78" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb43-79"><a href="#cb43-79" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Calculate accuracy</span></span>
<span id="cb43-80"><a href="#cb43-80" aria-hidden="true" tabindex="-1"></a>            y_pred_labels <span class="op">=</span> y_pred.argmax(dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb43-81"><a href="#cb43-81" aria-hidden="true" tabindex="-1"></a>            test_acc.update(y_pred_labels, y)</span>
<span id="cb43-82"><a href="#cb43-82" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-83"><a href="#cb43-83" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Averaging the loss and accuracy</span></span>
<span id="cb43-84"><a href="#cb43-84" aria-hidden="true" tabindex="-1"></a>    test_loss <span class="op">=</span> test_loss <span class="op">/</span> <span class="bu">len</span>(dataloader)</span>
<span id="cb43-85"><a href="#cb43-85" aria-hidden="true" tabindex="-1"></a>    test_acc <span class="op">=</span> test_acc.compute()</span>
<span id="cb43-86"><a href="#cb43-86" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> test_loss, test_acc</span>
<span id="cb43-87"><a href="#cb43-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-88"><a href="#cb43-88" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> model_train(epochs, model, train_dataloader, test_dataloader, optimizer, loss_fn, device, num_classes):</span>
<span id="cb43-89"><a href="#cb43-89" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb43-90"><a href="#cb43-90" aria-hidden="true" tabindex="-1"></a><span class="co">    Trains a pytorch model for a certain number of epochs going through the model training </span></span>
<span id="cb43-91"><a href="#cb43-91" aria-hidden="true" tabindex="-1"></a><span class="co">    and testing stage, and accumalating the loss, accuracy, and training and testing time.</span></span>
<span id="cb43-92"><a href="#cb43-92" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb43-93"><a href="#cb43-93" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb43-94"><a href="#cb43-94" aria-hidden="true" tabindex="-1"></a><span class="co">        epochs: A integer to run the training and testing stage. </span></span>
<span id="cb43-95"><a href="#cb43-95" aria-hidden="true" tabindex="-1"></a><span class="co">        model: A pytorch model for training and testing.</span></span>
<span id="cb43-96"><a href="#cb43-96" aria-hidden="true" tabindex="-1"></a><span class="co">        train_dataloader: A pytorch dataloader for training.</span></span>
<span id="cb43-97"><a href="#cb43-97" aria-hidden="true" tabindex="-1"></a><span class="co">        test_dataloader: A pytorch dataloader for testing.</span></span>
<span id="cb43-98"><a href="#cb43-98" aria-hidden="true" tabindex="-1"></a><span class="co">        loss_fn: A pytorch loss to calculate the model's prediction loss.</span></span>
<span id="cb43-99"><a href="#cb43-99" aria-hidden="true" tabindex="-1"></a><span class="co">        optimizer: A pytorch optimizer to minimize the loss function.</span></span>
<span id="cb43-100"><a href="#cb43-100" aria-hidden="true" tabindex="-1"></a><span class="co">        device: A torch device to allocate tensors on 'cpu' or 'cuda'.</span></span>
<span id="cb43-101"><a href="#cb43-101" aria-hidden="true" tabindex="-1"></a><span class="co">        num_classes: A integer that indicates total number of classes in the dataset.</span></span>
<span id="cb43-102"><a href="#cb43-102" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb43-103"><a href="#cb43-103" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns: A tuple of accumaleted results in dict and total training time in float datatype.</span></span>
<span id="cb43-104"><a href="#cb43-104" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb43-105"><a href="#cb43-105" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create empty result</span></span>
<span id="cb43-106"><a href="#cb43-106" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> {<span class="st">'train_loss'</span>: [],</span>
<span id="cb43-107"><a href="#cb43-107" aria-hidden="true" tabindex="-1"></a>               <span class="st">'train_acc'</span>: [],</span>
<span id="cb43-108"><a href="#cb43-108" aria-hidden="true" tabindex="-1"></a>               <span class="st">'test_loss'</span>: [],</span>
<span id="cb43-109"><a href="#cb43-109" aria-hidden="true" tabindex="-1"></a>               <span class="st">'test_acc'</span>: [],</span>
<span id="cb43-110"><a href="#cb43-110" aria-hidden="true" tabindex="-1"></a>               <span class="st">'train_epoch_time(min)'</span>: [],</span>
<span id="cb43-111"><a href="#cb43-111" aria-hidden="true" tabindex="-1"></a>               <span class="st">'test_epoch_time(min)'</span>: []}</span>
<span id="cb43-112"><a href="#cb43-112" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-113"><a href="#cb43-113" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Loop through training and testing steps</span></span>
<span id="cb43-114"><a href="#cb43-114" aria-hidden="true" tabindex="-1"></a>    model_train_start_time <span class="op">=</span> timer()</span>
<span id="cb43-115"><a href="#cb43-115" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> epoch <span class="kw">in</span> tqdm(<span class="bu">range</span>(epochs), desc<span class="op">=</span><span class="ss">f'Training and Evaluation for </span><span class="sc">{</span>epochs<span class="sc">}</span><span class="ss"> Epochs'</span>, unit<span class="op">=</span><span class="st">'epochs'</span>):</span>
<span id="cb43-116"><a href="#cb43-116" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Training the model and timing it.</span></span>
<span id="cb43-117"><a href="#cb43-117" aria-hidden="true" tabindex="-1"></a>        train_epoch_start_time <span class="op">=</span> timer()</span>
<span id="cb43-118"><a href="#cb43-118" aria-hidden="true" tabindex="-1"></a>        train_loss, train_acc <span class="op">=</span> train_step(model<span class="op">=</span>model, </span>
<span id="cb43-119"><a href="#cb43-119" aria-hidden="true" tabindex="-1"></a>                                           dataloader<span class="op">=</span>train_dataloader, </span>
<span id="cb43-120"><a href="#cb43-120" aria-hidden="true" tabindex="-1"></a>                                           loss_fn<span class="op">=</span>loss_fn, </span>
<span id="cb43-121"><a href="#cb43-121" aria-hidden="true" tabindex="-1"></a>                                           optimizer<span class="op">=</span>optimizer, </span>
<span id="cb43-122"><a href="#cb43-122" aria-hidden="true" tabindex="-1"></a>                                           device<span class="op">=</span>device, </span>
<span id="cb43-123"><a href="#cb43-123" aria-hidden="true" tabindex="-1"></a>                                           num_classes<span class="op">=</span>num_classes)</span>
<span id="cb43-124"><a href="#cb43-124" aria-hidden="true" tabindex="-1"></a>        train_epoch_stop_time <span class="op">=</span> timer()</span>
<span id="cb43-125"><a href="#cb43-125" aria-hidden="true" tabindex="-1"></a>        train_epoch_time <span class="op">=</span> (train_epoch_stop_time <span class="op">-</span> train_epoch_start_time)<span class="op">/</span><span class="dv">60</span></span>
<span id="cb43-126"><a href="#cb43-126" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb43-127"><a href="#cb43-127" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Testing the model and timing it</span></span>
<span id="cb43-128"><a href="#cb43-128" aria-hidden="true" tabindex="-1"></a>        test_epoch_start_time <span class="op">=</span> timer()</span>
<span id="cb43-129"><a href="#cb43-129" aria-hidden="true" tabindex="-1"></a>        test_loss, test_acc <span class="op">=</span> test_step(model<span class="op">=</span>model,</span>
<span id="cb43-130"><a href="#cb43-130" aria-hidden="true" tabindex="-1"></a>                                        dataloader<span class="op">=</span>test_dataloader,</span>
<span id="cb43-131"><a href="#cb43-131" aria-hidden="true" tabindex="-1"></a>                                        loss_fn<span class="op">=</span>loss_fn,</span>
<span id="cb43-132"><a href="#cb43-132" aria-hidden="true" tabindex="-1"></a>                                        device<span class="op">=</span>device,</span>
<span id="cb43-133"><a href="#cb43-133" aria-hidden="true" tabindex="-1"></a>                                        num_classes<span class="op">=</span>num_classes)</span>
<span id="cb43-134"><a href="#cb43-134" aria-hidden="true" tabindex="-1"></a>        test_epoch_stop_time <span class="op">=</span> timer()</span>
<span id="cb43-135"><a href="#cb43-135" aria-hidden="true" tabindex="-1"></a>        test_epoch_time <span class="op">=</span> (test_epoch_stop_time <span class="op">-</span> test_epoch_start_time)<span class="op">/</span><span class="dv">60</span></span>
<span id="cb43-136"><a href="#cb43-136" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb43-137"><a href="#cb43-137" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Print the model result</span></span>
<span id="cb43-138"><a href="#cb43-138" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'Epoch: [</span><span class="sc">{</span>epoch<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>epochs<span class="sc">}</span><span class="ss">] | train_loss: </span><span class="sc">{</span>train_loss<span class="sc">:.4f}</span><span class="ss"> | train_acc: </span><span class="sc">{</span>train_acc<span class="sc">:.4f}</span><span class="ss"> | train_time: </span><span class="sc">{</span>train_epoch_time<span class="sc">:.4f}</span><span class="ss"> min | '</span></span>
<span id="cb43-139"><a href="#cb43-139" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f'test loss: </span><span class="sc">{</span>test_loss<span class="sc">:.4f}</span><span class="ss"> | test_acc: </span><span class="sc">{</span>test_acc<span class="sc">:.4f}</span><span class="ss"> | test_time: </span><span class="sc">{</span>test_epoch_time<span class="sc">:.4f}</span><span class="ss"> min'</span>)</span>
<span id="cb43-140"><a href="#cb43-140" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb43-141"><a href="#cb43-141" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Saving the results</span></span>
<span id="cb43-142"><a href="#cb43-142" aria-hidden="true" tabindex="-1"></a>        results[<span class="st">'train_loss'</span>].append(train_loss)</span>
<span id="cb43-143"><a href="#cb43-143" aria-hidden="true" tabindex="-1"></a>        results[<span class="st">'train_acc'</span>].append(train_acc.detach().cpu().item())</span>
<span id="cb43-144"><a href="#cb43-144" aria-hidden="true" tabindex="-1"></a>        results[<span class="st">'test_loss'</span>].append(test_loss)</span>
<span id="cb43-145"><a href="#cb43-145" aria-hidden="true" tabindex="-1"></a>        results[<span class="st">'test_acc'</span>].append(test_acc.detach().cpu().item())</span>
<span id="cb43-146"><a href="#cb43-146" aria-hidden="true" tabindex="-1"></a>        results[<span class="st">'train_epoch_time(min)'</span>].append(train_epoch_time)</span>
<span id="cb43-147"><a href="#cb43-147" aria-hidden="true" tabindex="-1"></a>        results[<span class="st">'test_epoch_time(min)'</span>].append(test_epoch_time)</span>
<span id="cb43-148"><a href="#cb43-148" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb43-149"><a href="#cb43-149" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculating total model training time</span></span>
<span id="cb43-150"><a href="#cb43-150" aria-hidden="true" tabindex="-1"></a>    model_train_end_time <span class="op">=</span> timer()</span>
<span id="cb43-151"><a href="#cb43-151" aria-hidden="true" tabindex="-1"></a>    total_train_time <span class="op">=</span> (model_train_end_time <span class="op">-</span> model_train_start_time)<span class="op">/</span><span class="dv">60</span></span>
<span id="cb43-152"><a href="#cb43-152" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'</span><span class="ch">\n</span><span class="ss">Total Model Training Time: </span><span class="sc">{</span>total_train_time<span class="sc">:.4f}</span><span class="ss"> min'</span>)</span>
<span id="cb43-153"><a href="#cb43-153" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results, total_train_time</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="exp-1-pytorch-before-2.0-pytorch-eager-mode" class="level3">
<h3 class="anchored" data-anchor-id="exp-1-pytorch-before-2.0-pytorch-eager-mode">Exp 1: PyTorch Before 2.0 (PyTorch Eager Mode)</h3>
<div class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>set_seed(<span class="dv">42</span>)</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Initializing the model and dataloaders</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>model, transforms <span class="op">=</span> create_model(num_classes<span class="op">=</span><span class="bu">len</span>(dataset.classes), device<span class="op">=</span>device)</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>model.to(device)</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>train_dataloader <span class="op">=</span> create_dataloaders(dataset<span class="op">=</span>train_dataset, batch<span class="op">=</span>BATCH_SIZE, shuffle<span class="op">=</span><span class="va">True</span>, workers<span class="op">=</span>WORKERS)</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>test_dataloader <span class="op">=</span> create_dataloaders(dataset<span class="op">=</span>test_dataset, batch<span class="op">=</span>BATCH_SIZE, shuffle<span class="op">=</span><span class="va">False</span>, workers<span class="op">=</span>WORKERS)</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Intializing loss and optimizer</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>loss_fn <span class="op">=</span> torch.nn.CrossEntropyLoss()</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> torch.optim.Adam(params<span class="op">=</span>model.parameters(), lr<span class="op">=</span><span class="fl">0.0001</span>)</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Training the model using the function</span></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>NUM_EPOCHS <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>exp1_results, exp1_total_train_time <span class="op">=</span> model_train(epochs<span class="op">=</span>NUM_EPOCHS,</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>                                                  model<span class="op">=</span>model, </span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>                                                  train_dataloader<span class="op">=</span>train_dataloader, </span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>                                                  test_dataloader<span class="op">=</span>test_dataloader, </span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>                                                  optimizer<span class="op">=</span>optimizer, </span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>                                                  loss_fn<span class="op">=</span>loss_fn, </span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>                                                  device<span class="op">=</span>device, </span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>                                                  num_classes<span class="op">=</span><span class="bu">len</span>(dataset.classes))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Dataloaders Length: 118 for a batch size of: 16
Dataloaders Length: 39 for a batch size of: 16
Epoch: [1/3] | train_loss: 2.8535 | train_acc: 0.1986 | train_time: 1.4238 min | test loss: 2.6782 | test_acc: 0.4535 | test_time: 0.5183 min
Epoch: [2/3] | train_loss: 2.5991 | train_acc: 0.4163 | train_time: 1.4201 min | test loss: 2.4277 | test_acc: 0.5401 | test_time: 0.5181 min
Epoch: [3/3] | train_loss: 2.3602 | train_acc: 0.5238 | train_time: 1.3959 min | test loss: 2.2095 | test_acc: 0.5801 | test_time: 0.5176 min

Total Model Training Time: 5.7940 min</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"c8a35c6a5cb54d39be8af8257c46c0e7","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"66e9cbe9633a496bac81104afb459ef4","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"390296647365476da450222ac878abab","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"000ff12cabdc4dea8483a83d3cfee3b0","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"86d7f42e720b49b19d90762ddb6e764c","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"67688243a7c64b248baa62a95c68f311","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"2d8844b12aa24c29abfdd5f941f4c43e","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
<div class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating a result directory</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>RESULTS_DIR <span class="op">=</span> <span class="st">'results'</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> os.path.exists(RESULTS_DIR):</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'[INFO] results directory exists.'</span>)</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>    os.mkdir(RESULTS_DIR)</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'[INFO] results directory is been created.'</span>)</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Saving the result in csv format</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>exp1_results_filename <span class="op">=</span> <span class="st">'exp1_results.csv'</span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>exp1_results_df <span class="op">=</span> pd.DataFrame(exp1_results)</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>exp1_results_df.to_csv(os.path.join(RESULTS_DIR, exp1_results_filename), index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>exp1_results_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[INFO] results directory is been created.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="27">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">train_acc</th>
<th data-quarto-table-cell-role="th">test_loss</th>
<th data-quarto-table-cell-role="th">test_acc</th>
<th data-quarto-table-cell-role="th">train_epoch_time(min)</th>
<th data-quarto-table-cell-role="th">test_epoch_time(min)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2.853498</td>
<td>0.198623</td>
<td>2.678158</td>
<td>0.453526</td>
<td>1.423781</td>
<td>0.518263</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2.599148</td>
<td>0.416314</td>
<td>2.427746</td>
<td>0.540064</td>
<td>1.420147</td>
<td>0.518100</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2.360210</td>
<td>0.523835</td>
<td>2.209470</td>
<td>0.580128</td>
<td>1.395912</td>
<td>0.517590</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating and saving a dataframe for model train time </span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>model_train_time_filename <span class="op">=</span> <span class="st">'model_train_time.csv'</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>model_train_time_df <span class="op">=</span> pd.DataFrame({<span class="st">'model'</span>: [<span class="st">'Pytorch Eager'</span>], <span class="st">'training_time(min)'</span>: [exp1_total_train_time]})</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>model_train_time_df.to_csv(os.path.join(RESULTS_DIR, model_train_time_filename), index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>model_train_time_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="28">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">model</th>
<th data-quarto-table-cell-role="th">training_time(min)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Pytorch Eager</td>
<td>5.794009</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="exp-2-pytorch-2.0-pytorch-compile-mode" class="level3">
<h3 class="anchored" data-anchor-id="exp-2-pytorch-2.0-pytorch-compile-mode">Exp 2: PyTorch 2.0 (PyTorch Compile Mode)</h3>
<div class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>set_seed(<span class="dv">42</span>)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Initializing the model and dataloaders</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>model, transforms <span class="op">=</span> create_model(num_classes<span class="op">=</span><span class="bu">len</span>(dataset.classes), device<span class="op">=</span>device)</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>model.to(device)</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>train_dataloader <span class="op">=</span> create_dataloaders(dataset<span class="op">=</span>train_dataset, batch<span class="op">=</span>BATCH_SIZE, shuffle<span class="op">=</span><span class="va">True</span>, workers<span class="op">=</span>WORKERS)</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>test_dataloader <span class="op">=</span> create_dataloaders(dataset<span class="op">=</span>test_dataset, batch<span class="op">=</span>BATCH_SIZE, shuffle<span class="op">=</span><span class="va">False</span>, workers<span class="op">=</span>WORKERS)</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Intializing loss and optimizer</span></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>loss_fn <span class="op">=</span> torch.nn.CrossEntropyLoss()</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> torch.optim.Adam(params<span class="op">=</span>model.parameters(), lr<span class="op">=</span><span class="fl">0.0001</span>)</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Setting up compiled model(Introduced in PyTorch 2.0.0)</span></span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> torch.<span class="bu">compile</span>(model, mode<span class="op">=</span><span class="st">'default'</span>)</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Training the model using the function</span></span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>NUM_EPOCHS <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>exp2_results, exp2_total_train_time <span class="op">=</span> model_train(epochs<span class="op">=</span>NUM_EPOCHS,</span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>                                                  model<span class="op">=</span>model,</span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a>                                                  train_dataloader<span class="op">=</span>train_dataloader,</span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a>                                                  test_dataloader<span class="op">=</span>test_dataloader,</span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a>                                                  optimizer<span class="op">=</span>optimizer,</span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a>                                                  loss_fn<span class="op">=</span>loss_fn,</span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a>                                                  device<span class="op">=</span>device,</span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a>                                                  num_classes<span class="op">=</span><span class="bu">len</span>(dataset.classes))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Dataloaders Length: 118 for a batch size of: 16
Dataloaders Length: 39 for a batch size of: 16
Epoch: [1/3] | train_loss: 2.8451 | train_acc: 0.2013 | train_time: 2.3885 min | test loss: 2.6787 | test_acc: 0.4503 | test_time: 1.0454 min
Epoch: [2/3] | train_loss: 2.5908 | train_acc: 0.4460 | train_time: 1.6187 min | test loss: 2.4270 | test_acc: 0.5481 | test_time: 0.5678 min
Epoch: [3/3] | train_loss: 2.3663 | train_acc: 0.5101 | train_time: 1.6008 min | test loss: 2.2091 | test_acc: 0.5801 | test_time: 0.5694 min

Total Model Training Time: 7.7908 min</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"415f48cecbd24d5da7567d4d62fb9e72","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"32d052d83e0141e296f7824ab2d5ac5c","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/usr/local/lib/python3.9/dist-packages/torch/_inductor/compile_fx.py:90: UserWarning: TensorFloat32 tensor cores for float32 matrix multiplication available but not enabled. Consider setting `torch.set_float32_matmul_precision('high')` for better performance.
  warnings.warn(
[2023-04-06 06:39:50,385] torch._inductor.utils: [WARNING] using triton random, expect difference from eager</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"8fdba15aa9ba406abd39638204ee7ce9","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"8423e0c9c7534784bc1cbe16ded97ea4","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"cbc4c96977484acfb9fa601cd0094e5c","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"6dd839afc4dc4382901b2b79bf6be0e2","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"b4eac88506954c5dac90e8983595ab2f","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
<div class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Saving the result in csv format</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>exp2_results_filename <span class="op">=</span> <span class="st">'exp2_results.csv'</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>exp2_results_df <span class="op">=</span> pd.DataFrame(exp2_results)</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>exp2_results_df.to_csv(os.path.join(RESULTS_DIR, exp2_results_filename), index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>exp2_results_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="30">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">train_acc</th>
<th data-quarto-table-cell-role="th">test_loss</th>
<th data-quarto-table-cell-role="th">test_acc</th>
<th data-quarto-table-cell-role="th">train_epoch_time(min)</th>
<th data-quarto-table-cell-role="th">test_epoch_time(min)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2.845071</td>
<td>0.201271</td>
<td>2.678697</td>
<td>0.450321</td>
<td>2.388515</td>
<td>1.045425</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2.590763</td>
<td>0.445975</td>
<td>2.427013</td>
<td>0.548077</td>
<td>1.618742</td>
<td>0.567790</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2.366281</td>
<td>0.510064</td>
<td>2.209109</td>
<td>0.580128</td>
<td>1.600783</td>
<td>0.569392</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Updating and saving a dataframe for model train time </span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>model_train_time_df.loc[<span class="bu">len</span>(model_train_time_df)] <span class="op">=</span> [<span class="st">'Pytorch Compile'</span>, exp2_total_train_time]</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>model_train_time_df.to_csv(os.path.join(RESULTS_DIR, model_train_time_filename), index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>model_train_time_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="31">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">model</th>
<th data-quarto-table-cell-role="th">training_time(min)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Pytorch Eager</td>
<td>5.794009</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Pytorch Compile</td>
<td>7.790816</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
</section>
<section id="pytorch-lightning---model-training-and-testing" class="level2">
<h2 class="anchored" data-anchor-id="pytorch-lightning---model-training-and-testing">PyTorch Lightning - Model Training and Testing</h2>
<div class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> PyLightHMDB51(L.LightningModule):</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="co">    A Lightning Module containing Model training and validation step.</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters: </span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="co">        model: A PyTorch Model.</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a><span class="co">        loss_fn: A PyTorch loss function.</span></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a><span class="co">        optimizer: A Pytorch Optimizer.</span></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a><span class="co">        num_classes: A integer for total number of classes in the dataset.</span></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, model, loss_fn, optimizer, num_classes):</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model <span class="op">=</span> model</span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.loss_fn <span class="op">=</span> loss_fn</span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.optimizer <span class="op">=</span> optimizer</span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.num_classes <span class="op">=</span> num_classes</span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.train_acc <span class="op">=</span> torchmetrics.Accuracy(task<span class="op">=</span><span class="st">'multiclass'</span>, num_classes<span class="op">=</span><span class="va">self</span>.num_classes)</span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.test_acc <span class="op">=</span> torchmetrics.Accuracy(task<span class="op">=</span><span class="st">'multiclass'</span>, num_classes<span class="op">=</span><span class="va">self</span>.num_classes)</span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.model(x)</span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> training_step(<span class="va">self</span>, train_batch, batch_idx):</span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a>        X, y <span class="op">=</span> train_batch</span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a>        y_preds <span class="op">=</span> <span class="va">self</span>.forward(X)</span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true" tabindex="-1"></a>        loss <span class="op">=</span> <span class="va">self</span>.loss_fn(y_preds, y)</span>
<span id="cb54-26"><a href="#cb54-26" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.log(<span class="st">'train_loss'</span>, loss, prog_bar<span class="op">=</span><span class="va">True</span>, on_step<span class="op">=</span><span class="va">False</span>, on_epoch<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb54-27"><a href="#cb54-27" aria-hidden="true" tabindex="-1"></a>        y_pred_labels <span class="op">=</span> torch.argmax(torch.softmax(y_preds, dim<span class="op">=</span><span class="dv">1</span>), dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb54-28"><a href="#cb54-28" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.train_acc.update(y_pred_labels, y)</span>
<span id="cb54-29"><a href="#cb54-29" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.log(<span class="st">'train_acc'</span>, <span class="va">self</span>.train_acc, prog_bar<span class="op">=</span><span class="va">True</span>, on_step<span class="op">=</span><span class="va">False</span>, on_epoch<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb54-30"><a href="#cb54-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> loss</span>
<span id="cb54-31"><a href="#cb54-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-32"><a href="#cb54-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> validation_step(<span class="va">self</span>, val_batch, batch_idx):</span>
<span id="cb54-33"><a href="#cb54-33" aria-hidden="true" tabindex="-1"></a>        X, y <span class="op">=</span> val_batch</span>
<span id="cb54-34"><a href="#cb54-34" aria-hidden="true" tabindex="-1"></a>        y_preds <span class="op">=</span> <span class="va">self</span>.forward(X)</span>
<span id="cb54-35"><a href="#cb54-35" aria-hidden="true" tabindex="-1"></a>        loss <span class="op">=</span> <span class="va">self</span>.loss_fn(y_preds, y)</span>
<span id="cb54-36"><a href="#cb54-36" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.log(<span class="st">'test_loss'</span>, loss, prog_bar<span class="op">=</span><span class="va">True</span>, on_step<span class="op">=</span><span class="va">False</span>, on_epoch<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb54-37"><a href="#cb54-37" aria-hidden="true" tabindex="-1"></a>        y_pred_labels <span class="op">=</span> torch.argmax(torch.softmax(y_preds, dim<span class="op">=</span><span class="dv">1</span>), dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb54-38"><a href="#cb54-38" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.test_acc.update(y_pred_labels, y)</span>
<span id="cb54-39"><a href="#cb54-39" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.log(<span class="st">'test_acc'</span>, <span class="va">self</span>.test_acc, prog_bar<span class="op">=</span><span class="va">True</span>, on_step<span class="op">=</span><span class="va">False</span>, on_epoch<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb54-40"><a href="#cb54-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-41"><a href="#cb54-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> configure_optimizers(<span class="va">self</span>):</span>
<span id="cb54-42"><a href="#cb54-42" aria-hidden="true" tabindex="-1"></a>        optimizers <span class="op">=</span> <span class="va">self</span>.optimizer</span>
<span id="cb54-43"><a href="#cb54-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> optimizers</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="exp-3-pytorch-lightning" class="level3">
<h3 class="anchored" data-anchor-id="exp-3-pytorch-lightning">Exp 3: PyTorch Lightning</h3>
<div class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>set_seed(<span class="dv">42</span>)</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating the pytorch lightning trainer</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>NUM_EPOCHS <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>logger <span class="op">=</span> L.pytorch.loggers.CSVLogger(save_dir<span class="op">=</span>RESULTS_DIR, </span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>                                     name<span class="op">=</span><span class="st">"pytorch_lightning"</span>)</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>trainer <span class="op">=</span> L.Trainer(max_epochs<span class="op">=</span>NUM_EPOCHS, </span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>                    logger<span class="op">=</span>logger)</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Initializing the model and dataloaders</span></span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>model, transforms <span class="op">=</span> create_model(num_classes<span class="op">=</span><span class="bu">len</span>(dataset.classes), device<span class="op">=</span>device)</span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>train_dataloader <span class="op">=</span> create_dataloaders(dataset<span class="op">=</span>train_dataset, batch<span class="op">=</span>BATCH_SIZE, shuffle<span class="op">=</span><span class="va">True</span>, workers<span class="op">=</span>WORKERS)</span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>test_dataloader <span class="op">=</span> create_dataloaders(dataset<span class="op">=</span>test_dataset, batch<span class="op">=</span>BATCH_SIZE, shuffle<span class="op">=</span><span class="va">False</span>, workers<span class="op">=</span>WORKERS)</span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Intializing loss and optimizer</span></span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a>loss_fn <span class="op">=</span> torch.nn.CrossEntropyLoss()</span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> torch.optim.Adam(params<span class="op">=</span>model.parameters(), lr<span class="op">=</span><span class="fl">0.0001</span>)</span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Initializing the lightning module class</span></span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> PyLightHMDB51(model<span class="op">=</span>model, </span>
<span id="cb55-21"><a href="#cb55-21" aria-hidden="true" tabindex="-1"></a>                      loss_fn<span class="op">=</span>loss_fn, </span>
<span id="cb55-22"><a href="#cb55-22" aria-hidden="true" tabindex="-1"></a>                      optimizer<span class="op">=</span>optimizer, </span>
<span id="cb55-23"><a href="#cb55-23" aria-hidden="true" tabindex="-1"></a>                      num_classes<span class="op">=</span><span class="bu">len</span>(dataset.classes))</span>
<span id="cb55-24"><a href="#cb55-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-25"><a href="#cb55-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Fiting the model to trainer.</span></span>
<span id="cb55-26"><a href="#cb55-26" aria-hidden="true" tabindex="-1"></a>start_time <span class="op">=</span> timer()</span>
<span id="cb55-27"><a href="#cb55-27" aria-hidden="true" tabindex="-1"></a>trainer.fit(model<span class="op">=</span>model, </span>
<span id="cb55-28"><a href="#cb55-28" aria-hidden="true" tabindex="-1"></a>            train_dataloaders<span class="op">=</span>train_dataloader, </span>
<span id="cb55-29"><a href="#cb55-29" aria-hidden="true" tabindex="-1"></a>            val_dataloaders<span class="op">=</span>test_dataloader)</span>
<span id="cb55-30"><a href="#cb55-30" aria-hidden="true" tabindex="-1"></a>end_time <span class="op">=</span> timer()</span>
<span id="cb55-31"><a href="#cb55-31" aria-hidden="true" tabindex="-1"></a>exp3_total_train_time <span class="op">=</span> (end_time <span class="op">-</span> start_time)<span class="op">/</span><span class="dv">60</span></span>
<span id="cb55-32"><a href="#cb55-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Total Time to train the model: </span><span class="sc">{</span>exp3_total_train_time<span class="sc">:.4f}</span><span class="ss"> min'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>GPU available: True (cuda), used: True
TPU available: False, using: 0 TPU cores
IPU available: False, using: 0 IPUs
HPU available: False, using: 0 HPUs
You are using a CUDA device ('NVIDIA RTX A4000') that has Tensor Cores. To properly utilize them, you should set `torch.set_float32_matmul_precision('medium' | 'high')` which will trade-off precision for performance. For more details, read https://pytorch.org/docs/stable/generated/torch.set_float32_matmul_precision.html#torch.set_float32_matmul_precision
Missing logger folder: results/pytorch_lightning
LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]

  | Name      | Type               | Params
-------------------------------------------------
0 | model     | MViT               | 34.2 M
1 | loss_fn   | CrossEntropyLoss   | 0     
2 | train_acc | MulticlassAccuracy | 0     
3 | test_acc  | MulticlassAccuracy | 0     
-------------------------------------------------
15.4 K    Trainable params
34.2 M    Non-trainable params
34.2 M    Total params
136.982   Total estimated model params size (MB)
`Trainer.fit` stopped: `max_epochs=3` reached.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Dataloaders Length: 118 for a batch size of: 16
Dataloaders Length: 39 for a batch size of: 16
Total Time to train the model: 7.6887 min</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"b335c8b261b74d9a822dcc671d9f2cd9","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
<div class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Updating and saving a dataframe for model train time </span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>model_train_time_df.loc[<span class="bu">len</span>(model_train_time_df)] <span class="op">=</span> [<span class="st">'Pytorch Lightning'</span>, exp3_total_train_time]</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>model_train_time_df.to_csv(os.path.join(RESULTS_DIR, model_train_time_filename), index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>model_train_time_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="34">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">model</th>
<th data-quarto-table-cell-role="th">training_time(min)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Pytorch Eager</td>
<td>5.794009</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Pytorch Compile</td>
<td>7.790816</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Pytorch Lightning</td>
<td>7.688747</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="exp-4-pytorch-lightning---compile-mode" class="level3">
<h3 class="anchored" data-anchor-id="exp-4-pytorch-lightning---compile-mode">Exp 4: PyTorch Lightning - Compile Mode</h3>
<div class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>set_seed(<span class="dv">42</span>)</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating the pytorch lightning trainer</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>NUM_EPOCHS <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>logger <span class="op">=</span> L.pytorch.loggers.CSVLogger(save_dir<span class="op">=</span>RESULTS_DIR, </span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>                                     name<span class="op">=</span><span class="st">"pytorch_lightning_compile_mode"</span>)</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>trainer <span class="op">=</span> L.Trainer(max_epochs<span class="op">=</span>NUM_EPOCHS, </span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>                    logger<span class="op">=</span>logger)</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Initializing the model and dataloaders</span></span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>model, transforms <span class="op">=</span> create_model(num_classes<span class="op">=</span><span class="bu">len</span>(dataset.classes), device<span class="op">=</span>device)</span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>train_dataloader <span class="op">=</span> create_dataloaders(dataset<span class="op">=</span>train_dataset, batch<span class="op">=</span>BATCH_SIZE, shuffle<span class="op">=</span><span class="va">True</span>, workers<span class="op">=</span>WORKERS)</span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>test_dataloader <span class="op">=</span> create_dataloaders(dataset<span class="op">=</span>test_dataset, batch<span class="op">=</span>BATCH_SIZE, shuffle<span class="op">=</span><span class="va">False</span>, workers<span class="op">=</span>WORKERS)</span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Intializing loss and optimizer</span></span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a>loss_fn <span class="op">=</span> torch.nn.CrossEntropyLoss()</span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> torch.optim.Adam(params<span class="op">=</span>model.parameters(), lr<span class="op">=</span><span class="fl">0.0001</span>)</span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-19"><a href="#cb59-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Setting up compiled model(Introduced in PyTorch 2.0.0)</span></span>
<span id="cb59-20"><a href="#cb59-20" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> torch.<span class="bu">compile</span>(model, mode<span class="op">=</span><span class="st">'default'</span>)</span>
<span id="cb59-21"><a href="#cb59-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-22"><a href="#cb59-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Initializing the lightning module class</span></span>
<span id="cb59-23"><a href="#cb59-23" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> PyLightHMDB51(model<span class="op">=</span>model, </span>
<span id="cb59-24"><a href="#cb59-24" aria-hidden="true" tabindex="-1"></a>                      loss_fn<span class="op">=</span>loss_fn, </span>
<span id="cb59-25"><a href="#cb59-25" aria-hidden="true" tabindex="-1"></a>                      optimizer<span class="op">=</span>optimizer, </span>
<span id="cb59-26"><a href="#cb59-26" aria-hidden="true" tabindex="-1"></a>                      num_classes<span class="op">=</span><span class="bu">len</span>(dataset.classes))</span>
<span id="cb59-27"><a href="#cb59-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-28"><a href="#cb59-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Fiting the model to trainer.</span></span>
<span id="cb59-29"><a href="#cb59-29" aria-hidden="true" tabindex="-1"></a>start_time <span class="op">=</span> timer()</span>
<span id="cb59-30"><a href="#cb59-30" aria-hidden="true" tabindex="-1"></a>trainer.fit(model<span class="op">=</span>model, </span>
<span id="cb59-31"><a href="#cb59-31" aria-hidden="true" tabindex="-1"></a>            train_dataloaders<span class="op">=</span>train_dataloader, </span>
<span id="cb59-32"><a href="#cb59-32" aria-hidden="true" tabindex="-1"></a>            val_dataloaders<span class="op">=</span>test_dataloader)</span>
<span id="cb59-33"><a href="#cb59-33" aria-hidden="true" tabindex="-1"></a>end_time <span class="op">=</span> timer()</span>
<span id="cb59-34"><a href="#cb59-34" aria-hidden="true" tabindex="-1"></a>exp4_total_train_time <span class="op">=</span> (end_time <span class="op">-</span> start_time)<span class="op">/</span><span class="dv">60</span></span>
<span id="cb59-35"><a href="#cb59-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Total Time to train the model: </span><span class="sc">{</span>exp4_total_train_time<span class="sc">:.4f}</span><span class="ss"> min'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>GPU available: True (cuda), used: True
TPU available: False, using: 0 TPU cores
IPU available: False, using: 0 IPUs
HPU available: False, using: 0 HPUs
You are using a CUDA device ('NVIDIA RTX A4000') that has Tensor Cores. To properly utilize them, you should set `torch.set_float32_matmul_precision('medium' | 'high')` which will trade-off precision for performance. For more details, read https://pytorch.org/docs/stable/generated/torch.set_float32_matmul_precision.html#torch.set_float32_matmul_precision
Missing logger folder: results/pytorch_lightning_compile_mode
LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]

  | Name      | Type               | Params
-------------------------------------------------
0 | model     | OptimizedModule    | 34.2 M
1 | loss_fn   | CrossEntropyLoss   | 0     
2 | train_acc | MulticlassAccuracy | 0     
3 | test_acc  | MulticlassAccuracy | 0     
-------------------------------------------------
15.4 K    Trainable params
34.2 M    Non-trainable params
34.2 M    Total params
136.982   Total estimated model params size (MB)
[2023-04-06 06:56:20,261] torch._inductor.utils: [WARNING] using triton random, expect difference from eager
`Trainer.fit` stopped: `max_epochs=3` reached.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Dataloaders Length: 118 for a batch size of: 16
Dataloaders Length: 39 for a batch size of: 16
Total Time to train the model: 10.5425 min</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"ffd285060f40472faba7d4d0817274b0","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
<div class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Updating and saving a dataframe for model train time </span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>model_train_time_df.loc[<span class="bu">len</span>(model_train_time_df)] <span class="op">=</span> [<span class="st">'PyTorch Lightning + Compile'</span>, exp4_total_train_time]</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>model_train_time_df.to_csv(os.path.join(RESULTS_DIR, model_train_time_filename), index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>model_train_time_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="36">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">model</th>
<th data-quarto-table-cell-role="th">training_time(min)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Pytorch Eager</td>
<td>5.794009</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Pytorch Compile</td>
<td>7.790816</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Pytorch Lightning</td>
<td>7.688747</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>PyTorch Lightning + Compile</td>
<td>10.542457</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
</section>
<section id="lightning-fabric---model-training-and-testing" class="level2">
<h2 class="anchored" data-anchor-id="lightning-fabric---model-training-and-testing">Lightning Fabric - Model training and Testing</h2>
<div class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_step(model, dataloader, loss_fn, optimizer, fabric, num_classes):</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Trains a pytorch model by going into train mode and applying forward pass,</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a><span class="co">    loss calculation and optimizer step.</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a><span class="co">        model: A pytorch model for training.</span></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a><span class="co">        dataloader: A pytorch dataloader for training.</span></span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a><span class="co">        loss_fn: A pytorch loss to calculate the model's prediction loss.</span></span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a><span class="co">        optimizer: A pytorch optimizer to minimize the loss function.</span></span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a><span class="co">        fabric: A Fabric function to setup device for the tensors and gradients.</span></span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a><span class="co">        num_classes: A integer that indicates total number of classes in the dataset.</span></span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns: A tuple of training loss and training accuracy.</span></span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Model on training mode</span></span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true" tabindex="-1"></a>    model.train()</span>
<span id="cb63-19"><a href="#cb63-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-20"><a href="#cb63-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Setting train loss and accuracy </span></span>
<span id="cb63-21"><a href="#cb63-21" aria-hidden="true" tabindex="-1"></a>    train_loss <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb63-22"><a href="#cb63-22" aria-hidden="true" tabindex="-1"></a>    train_acc <span class="op">=</span> torchmetrics.Accuracy(task<span class="op">=</span><span class="st">'multiclass'</span>, num_classes<span class="op">=</span>num_classes).to(fabric.device) <span class="co"># New by Fabric</span></span>
<span id="cb63-23"><a href="#cb63-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-24"><a href="#cb63-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Looping the dataloaders</span></span>
<span id="cb63-25"><a href="#cb63-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> batch, (X, y) <span class="kw">in</span> tqdm(<span class="bu">enumerate</span>(dataloader), desc<span class="op">=</span><span class="st">'Model Training'</span>, total<span class="op">=</span><span class="bu">len</span>(dataloader), unit<span class="op">=</span><span class="st">'batch'</span>):</span>
<span id="cb63-26"><a href="#cb63-26" aria-hidden="true" tabindex="-1"></a>        <span class="co"># X, y = X.to(device), y.to(device) # New by Fabric</span></span>
<span id="cb63-27"><a href="#cb63-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb63-28"><a href="#cb63-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 5 step to train a model</span></span>
<span id="cb63-29"><a href="#cb63-29" aria-hidden="true" tabindex="-1"></a>        y_pred <span class="op">=</span> model(X) <span class="co"># 1. Forward pass</span></span>
<span id="cb63-30"><a href="#cb63-30" aria-hidden="true" tabindex="-1"></a>        loss <span class="op">=</span> loss_fn(y_pred, y) <span class="co"># 2. Calculate loss</span></span>
<span id="cb63-31"><a href="#cb63-31" aria-hidden="true" tabindex="-1"></a>        train_loss <span class="op">+=</span> loss.item() </span>
<span id="cb63-32"><a href="#cb63-32" aria-hidden="true" tabindex="-1"></a>        optimizer.zero_grad() <span class="co"># 3. Initiate optimizer</span></span>
<span id="cb63-33"><a href="#cb63-33" aria-hidden="true" tabindex="-1"></a>        <span class="co">#loss.backward() # 4. Backward pass</span></span>
<span id="cb63-34"><a href="#cb63-34" aria-hidden="true" tabindex="-1"></a>        fabric.backward(loss) <span class="co"># New by Fabric</span></span>
<span id="cb63-35"><a href="#cb63-35" aria-hidden="true" tabindex="-1"></a>        optimizer.step() <span class="co"># 5. Updating the model parameters</span></span>
<span id="cb63-36"><a href="#cb63-36" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb63-37"><a href="#cb63-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculating the training accuracy</span></span>
<span id="cb63-38"><a href="#cb63-38" aria-hidden="true" tabindex="-1"></a>        y_pred_labels <span class="op">=</span> torch.argmax(torch.softmax(y_pred, dim<span class="op">=</span><span class="dv">1</span>), dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb63-39"><a href="#cb63-39" aria-hidden="true" tabindex="-1"></a>        train_acc.update(y_pred_labels, y)</span>
<span id="cb63-40"><a href="#cb63-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-41"><a href="#cb63-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Averaging the loss and accuracy</span></span>
<span id="cb63-42"><a href="#cb63-42" aria-hidden="true" tabindex="-1"></a>    train_loss <span class="op">=</span> train_loss <span class="op">/</span> <span class="bu">len</span>(dataloader)</span>
<span id="cb63-43"><a href="#cb63-43" aria-hidden="true" tabindex="-1"></a>    train_acc <span class="op">=</span> train_acc.compute()</span>
<span id="cb63-44"><a href="#cb63-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> train_loss, train_acc</span>
<span id="cb63-45"><a href="#cb63-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-46"><a href="#cb63-46" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_step(model, dataloader, loss_fn, fabric, num_classes):</span>
<span id="cb63-47"><a href="#cb63-47" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb63-48"><a href="#cb63-48" aria-hidden="true" tabindex="-1"></a><span class="co">    Test a pytorch model by going into eval mode and applying forward pass,</span></span>
<span id="cb63-49"><a href="#cb63-49" aria-hidden="true" tabindex="-1"></a><span class="co">    and loss calculation.</span></span>
<span id="cb63-50"><a href="#cb63-50" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb63-51"><a href="#cb63-51" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb63-52"><a href="#cb63-52" aria-hidden="true" tabindex="-1"></a><span class="co">        model: A pytorch model for testing.</span></span>
<span id="cb63-53"><a href="#cb63-53" aria-hidden="true" tabindex="-1"></a><span class="co">        dataloader: A pytorch dataloader for testing.</span></span>
<span id="cb63-54"><a href="#cb63-54" aria-hidden="true" tabindex="-1"></a><span class="co">        loss_fn: A pytorch loss to calculate the model's prediction loss.</span></span>
<span id="cb63-55"><a href="#cb63-55" aria-hidden="true" tabindex="-1"></a><span class="co">        fabric: A Fabric function to setup device for the tensors and gradients.</span></span>
<span id="cb63-56"><a href="#cb63-56" aria-hidden="true" tabindex="-1"></a><span class="co">        num_classes: A integer that indicates total number of classes in the dataset.</span></span>
<span id="cb63-57"><a href="#cb63-57" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb63-58"><a href="#cb63-58" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns: A tuple of testing loss and testing accuracy.</span></span>
<span id="cb63-59"><a href="#cb63-59" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb63-60"><a href="#cb63-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Model on evaluation mode</span></span>
<span id="cb63-61"><a href="#cb63-61" aria-hidden="true" tabindex="-1"></a>    model.<span class="bu">eval</span>()</span>
<span id="cb63-62"><a href="#cb63-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-63"><a href="#cb63-63" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Setting train loss and accuracy </span></span>
<span id="cb63-64"><a href="#cb63-64" aria-hidden="true" tabindex="-1"></a>    test_loss <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb63-65"><a href="#cb63-65" aria-hidden="true" tabindex="-1"></a>    test_acc <span class="op">=</span> torchmetrics.Accuracy(task<span class="op">=</span><span class="st">'multiclass'</span>, num_classes<span class="op">=</span>num_classes).to(fabric.device) <span class="co"># New by Fabric</span></span>
<span id="cb63-66"><a href="#cb63-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-67"><a href="#cb63-67" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Using inference mode</span></span>
<span id="cb63-68"><a href="#cb63-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> torch.no_grad():</span>
<span id="cb63-69"><a href="#cb63-69" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Looping the dataloaders</span></span>
<span id="cb63-70"><a href="#cb63-70" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> batch, (X, y) <span class="kw">in</span> tqdm(<span class="bu">enumerate</span>(dataloader), desc<span class="op">=</span><span class="st">'Model Evaluation'</span>, total<span class="op">=</span><span class="bu">len</span>(dataloader), unit<span class="op">=</span><span class="st">'batch'</span>):</span>
<span id="cb63-71"><a href="#cb63-71" aria-hidden="true" tabindex="-1"></a>            <span class="co"># X, y = X.to(device), y.to(device) # New by Fabric</span></span>
<span id="cb63-72"><a href="#cb63-72" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb63-73"><a href="#cb63-73" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Forward pass</span></span>
<span id="cb63-74"><a href="#cb63-74" aria-hidden="true" tabindex="-1"></a>            y_pred <span class="op">=</span> model(X)</span>
<span id="cb63-75"><a href="#cb63-75" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb63-76"><a href="#cb63-76" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Calculate loss</span></span>
<span id="cb63-77"><a href="#cb63-77" aria-hidden="true" tabindex="-1"></a>            loss <span class="op">=</span> loss_fn(y_pred, y)</span>
<span id="cb63-78"><a href="#cb63-78" aria-hidden="true" tabindex="-1"></a>            test_loss <span class="op">+=</span> loss.item()</span>
<span id="cb63-79"><a href="#cb63-79" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb63-80"><a href="#cb63-80" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Calculate accuracy</span></span>
<span id="cb63-81"><a href="#cb63-81" aria-hidden="true" tabindex="-1"></a>            y_pred_labels <span class="op">=</span> y_pred.argmax(dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb63-82"><a href="#cb63-82" aria-hidden="true" tabindex="-1"></a>            test_acc.update(y_pred_labels, y)</span>
<span id="cb63-83"><a href="#cb63-83" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-84"><a href="#cb63-84" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Averaging the loss and accuracy</span></span>
<span id="cb63-85"><a href="#cb63-85" aria-hidden="true" tabindex="-1"></a>    test_loss <span class="op">=</span> test_loss <span class="op">/</span> <span class="bu">len</span>(dataloader)</span>
<span id="cb63-86"><a href="#cb63-86" aria-hidden="true" tabindex="-1"></a>    test_acc <span class="op">=</span> test_acc.compute()</span>
<span id="cb63-87"><a href="#cb63-87" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> test_loss, test_acc</span>
<span id="cb63-88"><a href="#cb63-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-89"><a href="#cb63-89" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> model_train(epochs, model, train_dataloader, test_dataloader, optimizer, loss_fn, fabric, num_classes):</span>
<span id="cb63-90"><a href="#cb63-90" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb63-91"><a href="#cb63-91" aria-hidden="true" tabindex="-1"></a><span class="co">    Trains a pytorch model for a certain number of epochs going through the model training </span></span>
<span id="cb63-92"><a href="#cb63-92" aria-hidden="true" tabindex="-1"></a><span class="co">    and testing stage, and accumalating the loss, accuracy, and training and testing time.</span></span>
<span id="cb63-93"><a href="#cb63-93" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb63-94"><a href="#cb63-94" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb63-95"><a href="#cb63-95" aria-hidden="true" tabindex="-1"></a><span class="co">        epochs: A integer to run the training and testing stage. </span></span>
<span id="cb63-96"><a href="#cb63-96" aria-hidden="true" tabindex="-1"></a><span class="co">        model: A pytorch model for training and testing.</span></span>
<span id="cb63-97"><a href="#cb63-97" aria-hidden="true" tabindex="-1"></a><span class="co">        train_dataloader: A pytorch dataloader for training.</span></span>
<span id="cb63-98"><a href="#cb63-98" aria-hidden="true" tabindex="-1"></a><span class="co">        test_dataloader: A pytorch dataloader for testing.</span></span>
<span id="cb63-99"><a href="#cb63-99" aria-hidden="true" tabindex="-1"></a><span class="co">        loss_fn: A pytorch loss to calculate the model's prediction loss.</span></span>
<span id="cb63-100"><a href="#cb63-100" aria-hidden="true" tabindex="-1"></a><span class="co">        optimizer: A pytorch optimizer to minimize the loss function.</span></span>
<span id="cb63-101"><a href="#cb63-101" aria-hidden="true" tabindex="-1"></a><span class="co">        fabric: A Fabric function to setup device for the tensors and gradients.</span></span>
<span id="cb63-102"><a href="#cb63-102" aria-hidden="true" tabindex="-1"></a><span class="co">        num_classes: A integer that indicates total number of classes in the dataset.</span></span>
<span id="cb63-103"><a href="#cb63-103" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb63-104"><a href="#cb63-104" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns: A tuple of accumaleted results in dict and total training time in float datatype.</span></span>
<span id="cb63-105"><a href="#cb63-105" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb63-106"><a href="#cb63-106" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create empty result</span></span>
<span id="cb63-107"><a href="#cb63-107" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> {<span class="st">'train_loss'</span>: [],</span>
<span id="cb63-108"><a href="#cb63-108" aria-hidden="true" tabindex="-1"></a>               <span class="st">'train_acc'</span>: [],</span>
<span id="cb63-109"><a href="#cb63-109" aria-hidden="true" tabindex="-1"></a>               <span class="st">'test_loss'</span>: [],</span>
<span id="cb63-110"><a href="#cb63-110" aria-hidden="true" tabindex="-1"></a>               <span class="st">'test_acc'</span>: [],</span>
<span id="cb63-111"><a href="#cb63-111" aria-hidden="true" tabindex="-1"></a>               <span class="st">'train_epoch_time(min)'</span>: [],</span>
<span id="cb63-112"><a href="#cb63-112" aria-hidden="true" tabindex="-1"></a>               <span class="st">'test_epoch_time(min)'</span>: []}</span>
<span id="cb63-113"><a href="#cb63-113" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-114"><a href="#cb63-114" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Loop through training and testing steps</span></span>
<span id="cb63-115"><a href="#cb63-115" aria-hidden="true" tabindex="-1"></a>    model_train_start_time <span class="op">=</span> timer()</span>
<span id="cb63-116"><a href="#cb63-116" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> epoch <span class="kw">in</span> tqdm(<span class="bu">range</span>(epochs), desc<span class="op">=</span><span class="ss">f'Training and Evaluation for </span><span class="sc">{</span>epochs<span class="sc">}</span><span class="ss"> Epochs'</span>, unit<span class="op">=</span><span class="st">'epochs'</span>):</span>
<span id="cb63-117"><a href="#cb63-117" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Training the model and timing it.</span></span>
<span id="cb63-118"><a href="#cb63-118" aria-hidden="true" tabindex="-1"></a>        train_epoch_start_time <span class="op">=</span> timer()</span>
<span id="cb63-119"><a href="#cb63-119" aria-hidden="true" tabindex="-1"></a>        train_loss, train_acc <span class="op">=</span> train_step(model<span class="op">=</span>model, </span>
<span id="cb63-120"><a href="#cb63-120" aria-hidden="true" tabindex="-1"></a>                                           dataloader<span class="op">=</span>train_dataloader, </span>
<span id="cb63-121"><a href="#cb63-121" aria-hidden="true" tabindex="-1"></a>                                           loss_fn<span class="op">=</span>loss_fn, </span>
<span id="cb63-122"><a href="#cb63-122" aria-hidden="true" tabindex="-1"></a>                                           optimizer<span class="op">=</span>optimizer, </span>
<span id="cb63-123"><a href="#cb63-123" aria-hidden="true" tabindex="-1"></a>                                           fabric<span class="op">=</span>fabric, <span class="co"># New by Fabric</span></span>
<span id="cb63-124"><a href="#cb63-124" aria-hidden="true" tabindex="-1"></a>                                           num_classes<span class="op">=</span>num_classes)</span>
<span id="cb63-125"><a href="#cb63-125" aria-hidden="true" tabindex="-1"></a>        train_epoch_stop_time <span class="op">=</span> timer()</span>
<span id="cb63-126"><a href="#cb63-126" aria-hidden="true" tabindex="-1"></a>        train_epoch_time <span class="op">=</span> (train_epoch_stop_time <span class="op">-</span> train_epoch_start_time)<span class="op">/</span><span class="dv">60</span></span>
<span id="cb63-127"><a href="#cb63-127" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb63-128"><a href="#cb63-128" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Testing the model and timing it</span></span>
<span id="cb63-129"><a href="#cb63-129" aria-hidden="true" tabindex="-1"></a>        test_epoch_start_time <span class="op">=</span> timer()</span>
<span id="cb63-130"><a href="#cb63-130" aria-hidden="true" tabindex="-1"></a>        test_loss, test_acc <span class="op">=</span> test_step(model<span class="op">=</span>model,</span>
<span id="cb63-131"><a href="#cb63-131" aria-hidden="true" tabindex="-1"></a>                                        dataloader<span class="op">=</span>test_dataloader,</span>
<span id="cb63-132"><a href="#cb63-132" aria-hidden="true" tabindex="-1"></a>                                        loss_fn<span class="op">=</span>loss_fn,</span>
<span id="cb63-133"><a href="#cb63-133" aria-hidden="true" tabindex="-1"></a>                                        fabric<span class="op">=</span>fabric, <span class="co"># New by Fabric</span></span>
<span id="cb63-134"><a href="#cb63-134" aria-hidden="true" tabindex="-1"></a>                                        num_classes<span class="op">=</span>num_classes)</span>
<span id="cb63-135"><a href="#cb63-135" aria-hidden="true" tabindex="-1"></a>        test_epoch_stop_time <span class="op">=</span> timer()</span>
<span id="cb63-136"><a href="#cb63-136" aria-hidden="true" tabindex="-1"></a>        test_epoch_time <span class="op">=</span> (test_epoch_stop_time <span class="op">-</span> test_epoch_start_time)<span class="op">/</span><span class="dv">60</span></span>
<span id="cb63-137"><a href="#cb63-137" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb63-138"><a href="#cb63-138" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Print the model result</span></span>
<span id="cb63-139"><a href="#cb63-139" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'Epoch: [</span><span class="sc">{</span>epoch<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>epochs<span class="sc">}</span><span class="ss">] | train_loss: </span><span class="sc">{</span>train_loss<span class="sc">:.4f}</span><span class="ss"> | train_acc: </span><span class="sc">{</span>train_acc<span class="sc">:.4f}</span><span class="ss"> | train_time: </span><span class="sc">{</span>train_epoch_time<span class="sc">:.4f}</span><span class="ss"> min | '</span></span>
<span id="cb63-140"><a href="#cb63-140" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f'test loss: </span><span class="sc">{</span>test_loss<span class="sc">:.4f}</span><span class="ss"> | test_acc: </span><span class="sc">{</span>test_acc<span class="sc">:.4f}</span><span class="ss"> | test_time: </span><span class="sc">{</span>test_epoch_time<span class="sc">:.4f}</span><span class="ss"> min'</span>)</span>
<span id="cb63-141"><a href="#cb63-141" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb63-142"><a href="#cb63-142" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Saving the results</span></span>
<span id="cb63-143"><a href="#cb63-143" aria-hidden="true" tabindex="-1"></a>        results[<span class="st">'train_loss'</span>].append(train_loss)</span>
<span id="cb63-144"><a href="#cb63-144" aria-hidden="true" tabindex="-1"></a>        results[<span class="st">'train_acc'</span>].append(train_acc.detach().cpu().item())</span>
<span id="cb63-145"><a href="#cb63-145" aria-hidden="true" tabindex="-1"></a>        results[<span class="st">'test_loss'</span>].append(test_loss)</span>
<span id="cb63-146"><a href="#cb63-146" aria-hidden="true" tabindex="-1"></a>        results[<span class="st">'test_acc'</span>].append(test_acc.detach().cpu().item())</span>
<span id="cb63-147"><a href="#cb63-147" aria-hidden="true" tabindex="-1"></a>        results[<span class="st">'train_epoch_time(min)'</span>].append(train_epoch_time)</span>
<span id="cb63-148"><a href="#cb63-148" aria-hidden="true" tabindex="-1"></a>        results[<span class="st">'test_epoch_time(min)'</span>].append(test_epoch_time)</span>
<span id="cb63-149"><a href="#cb63-149" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb63-150"><a href="#cb63-150" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculating total model training time</span></span>
<span id="cb63-151"><a href="#cb63-151" aria-hidden="true" tabindex="-1"></a>    model_train_end_time <span class="op">=</span> timer()</span>
<span id="cb63-152"><a href="#cb63-152" aria-hidden="true" tabindex="-1"></a>    total_train_time <span class="op">=</span> (model_train_end_time <span class="op">-</span> model_train_start_time)<span class="op">/</span><span class="dv">60</span></span>
<span id="cb63-153"><a href="#cb63-153" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'</span><span class="ch">\n</span><span class="ss">Total Model Training Time: </span><span class="sc">{</span>total_train_time<span class="sc">:.4f}</span><span class="ss"> min'</span>)</span>
<span id="cb63-154"><a href="#cb63-154" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results, total_train_time</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="exp-5-fabric-lightning" class="level3">
<h3 class="anchored" data-anchor-id="exp-5-fabric-lightning">Exp 5: Fabric Lightning</h3>
<div class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>set_seed(<span class="dv">42</span>)</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Initializing Fabric # New by Fabric</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>fabric <span class="op">=</span> Fabric()</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Initializing the model and dataloaders</span></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>model, transforms <span class="op">=</span> create_model(num_classes<span class="op">=</span><span class="bu">len</span>(dataset.classes), device<span class="op">=</span>fabric.device) <span class="co"># New by Fabric</span></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a><span class="co"># model.to(device)</span></span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>train_dataloader <span class="op">=</span> create_dataloaders(dataset<span class="op">=</span>train_dataset, batch<span class="op">=</span>BATCH_SIZE, shuffle<span class="op">=</span><span class="va">True</span>, workers<span class="op">=</span>WORKERS)</span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>test_dataloader <span class="op">=</span> create_dataloaders(dataset<span class="op">=</span>test_dataset, batch<span class="op">=</span>BATCH_SIZE, shuffle<span class="op">=</span><span class="va">False</span>, workers<span class="op">=</span>WORKERS)</span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Intializing loss and optimizer</span></span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>loss_fn <span class="op">=</span> torch.nn.CrossEntropyLoss()</span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> torch.optim.Adam(params<span class="op">=</span>model.parameters(), lr<span class="op">=</span><span class="fl">0.0001</span>)</span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Fabric setup # New by Fabric</span></span>
<span id="cb64-17"><a href="#cb64-17" aria-hidden="true" tabindex="-1"></a>model, optimizer <span class="op">=</span> fabric.setup(model, optimizer)</span>
<span id="cb64-18"><a href="#cb64-18" aria-hidden="true" tabindex="-1"></a>train_dataloader, test_dataloader <span class="op">=</span> fabric.setup_dataloaders(train_dataloader, test_dataloader)</span>
<span id="cb64-19"><a href="#cb64-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-20"><a href="#cb64-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Training the model using the function</span></span>
<span id="cb64-21"><a href="#cb64-21" aria-hidden="true" tabindex="-1"></a>NUM_EPOCHS <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb64-22"><a href="#cb64-22" aria-hidden="true" tabindex="-1"></a>exp5_results, exp5_total_train_time <span class="op">=</span> model_train(epochs<span class="op">=</span>NUM_EPOCHS,</span>
<span id="cb64-23"><a href="#cb64-23" aria-hidden="true" tabindex="-1"></a>                                                  model<span class="op">=</span>model, </span>
<span id="cb64-24"><a href="#cb64-24" aria-hidden="true" tabindex="-1"></a>                                                  train_dataloader<span class="op">=</span>train_dataloader, </span>
<span id="cb64-25"><a href="#cb64-25" aria-hidden="true" tabindex="-1"></a>                                                  test_dataloader<span class="op">=</span>test_dataloader, </span>
<span id="cb64-26"><a href="#cb64-26" aria-hidden="true" tabindex="-1"></a>                                                  optimizer<span class="op">=</span>optimizer, </span>
<span id="cb64-27"><a href="#cb64-27" aria-hidden="true" tabindex="-1"></a>                                                  loss_fn<span class="op">=</span>loss_fn, </span>
<span id="cb64-28"><a href="#cb64-28" aria-hidden="true" tabindex="-1"></a>                                                  fabric<span class="op">=</span>fabric, </span>
<span id="cb64-29"><a href="#cb64-29" aria-hidden="true" tabindex="-1"></a>                                                  num_classes<span class="op">=</span><span class="bu">len</span>(dataset.classes))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>You are using a CUDA device ('NVIDIA RTX A4000') that has Tensor Cores. To properly utilize them, you should set `torch.set_float32_matmul_precision('medium' | 'high')` which will trade-off precision for performance. For more details, read https://pytorch.org/docs/stable/generated/torch.set_float32_matmul_precision.html#torch.set_float32_matmul_precision</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Dataloaders Length: 118 for a batch size of: 16
Dataloaders Length: 39 for a batch size of: 16
Epoch: [1/3] | train_loss: 2.8535 | train_acc: 0.1986 | train_time: 1.5801 min | test loss: 2.6782 | test_acc: 0.4535 | test_time: 0.5829 min
Epoch: [2/3] | train_loss: 2.5991 | train_acc: 0.4163 | train_time: 1.5967 min | test loss: 2.4277 | test_acc: 0.5401 | test_time: 0.5939 min
Epoch: [3/3] | train_loss: 2.3602 | train_acc: 0.5238 | train_time: 1.5900 min | test loss: 2.2095 | test_acc: 0.5801 | test_time: 0.6074 min

Total Model Training Time: 6.5512 min</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"0a2c1cc5e4a54a87a5befb90a9166b62","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"40aa61cee06e40739e61ef8c08e966b4","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"5882ef7d10664ab9b26dc4a1f1a67855","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"a17bb50f81c640a9822315f6f17872e3","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"a1db38681a164e7a873e96f977cee366","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"d9af36ba63874d2ab935aaea43af1be5","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"10d2855521d04cb38c34a35f16c65b71","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
<div class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Saving the result in csv format</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>exp5_results_filename <span class="op">=</span> <span class="st">'exp5_results.csv'</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>exp5_results_df <span class="op">=</span> pd.DataFrame(exp5_results)</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>exp5_results_df.to_csv(os.path.join(RESULTS_DIR, exp5_results_filename), index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>exp5_results_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="39">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">train_acc</th>
<th data-quarto-table-cell-role="th">test_loss</th>
<th data-quarto-table-cell-role="th">test_acc</th>
<th data-quarto-table-cell-role="th">train_epoch_time(min)</th>
<th data-quarto-table-cell-role="th">test_epoch_time(min)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2.853498</td>
<td>0.198623</td>
<td>2.678158</td>
<td>0.453526</td>
<td>1.580098</td>
<td>0.582881</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2.599148</td>
<td>0.416314</td>
<td>2.427746</td>
<td>0.540064</td>
<td>1.596745</td>
<td>0.593947</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2.360210</td>
<td>0.523835</td>
<td>2.209470</td>
<td>0.580128</td>
<td>1.590004</td>
<td>0.607377</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Updating and saving a dataframe for model train time </span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>model_train_time_df.loc[<span class="bu">len</span>(model_train_time_df)] <span class="op">=</span> [<span class="st">'Fabric Lightning'</span>, exp5_total_train_time]</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>model_train_time_df.to_csv(os.path.join(RESULTS_DIR, model_train_time_filename), index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>model_train_time_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="40">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">model</th>
<th data-quarto-table-cell-role="th">training_time(min)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Pytorch Eager</td>
<td>5.794009</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Pytorch Compile</td>
<td>7.790816</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Pytorch Lightning</td>
<td>7.688747</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>PyTorch Lightning + Compile</td>
<td>10.542457</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Fabric Lightning</td>
<td>6.551208</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="exp-6-fabric-lightning---compile-mode" class="level3">
<h3 class="anchored" data-anchor-id="exp-6-fabric-lightning---compile-mode">Exp 6: Fabric Lightning - Compile mode</h3>
<div class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>set_seed(<span class="dv">42</span>)</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Initializing Fabric # New by Fabric</span></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>fabric <span class="op">=</span> Fabric()</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Initializing the model and dataloaders</span></span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>model, transforms <span class="op">=</span> create_model(num_classes<span class="op">=</span><span class="bu">len</span>(dataset.classes), device<span class="op">=</span>fabric.device) <span class="co"># New by Fabric</span></span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a><span class="co"># model.to(device)</span></span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>train_dataloader <span class="op">=</span> create_dataloaders(dataset<span class="op">=</span>train_dataset, batch<span class="op">=</span>BATCH_SIZE, shuffle<span class="op">=</span><span class="va">True</span>, workers<span class="op">=</span>WORKERS)</span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>test_dataloader <span class="op">=</span> create_dataloaders(dataset<span class="op">=</span>test_dataset, batch<span class="op">=</span>BATCH_SIZE, shuffle<span class="op">=</span><span class="va">False</span>, workers<span class="op">=</span>WORKERS)</span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Intializing loss and optimizer</span></span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a>loss_fn <span class="op">=</span> torch.nn.CrossEntropyLoss()</span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> torch.optim.Adam(params<span class="op">=</span>model.parameters(), lr<span class="op">=</span><span class="fl">0.0001</span>)</span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Fabric setup # New by Fabric</span></span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a>model, optimizer <span class="op">=</span> fabric.setup(model, optimizer)</span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true" tabindex="-1"></a>train_dataloader, test_dataloader <span class="op">=</span> fabric.setup_dataloaders(train_dataloader, test_dataloader)</span>
<span id="cb69-19"><a href="#cb69-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-20"><a href="#cb69-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Setting up compiled model(Introduced in PyTorch 2.0.0)</span></span>
<span id="cb69-21"><a href="#cb69-21" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> torch.<span class="bu">compile</span>(model, mode<span class="op">=</span><span class="st">'default'</span>)</span>
<span id="cb69-22"><a href="#cb69-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-23"><a href="#cb69-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Training the model using the function</span></span>
<span id="cb69-24"><a href="#cb69-24" aria-hidden="true" tabindex="-1"></a>NUM_EPOCHS <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb69-25"><a href="#cb69-25" aria-hidden="true" tabindex="-1"></a>exp6_results, exp6_total_train_time <span class="op">=</span> model_train(epochs<span class="op">=</span>NUM_EPOCHS,</span>
<span id="cb69-26"><a href="#cb69-26" aria-hidden="true" tabindex="-1"></a>                                                  model<span class="op">=</span>model, </span>
<span id="cb69-27"><a href="#cb69-27" aria-hidden="true" tabindex="-1"></a>                                                  train_dataloader<span class="op">=</span>train_dataloader, </span>
<span id="cb69-28"><a href="#cb69-28" aria-hidden="true" tabindex="-1"></a>                                                  test_dataloader<span class="op">=</span>test_dataloader, </span>
<span id="cb69-29"><a href="#cb69-29" aria-hidden="true" tabindex="-1"></a>                                                  optimizer<span class="op">=</span>optimizer, </span>
<span id="cb69-30"><a href="#cb69-30" aria-hidden="true" tabindex="-1"></a>                                                  loss_fn<span class="op">=</span>loss_fn, </span>
<span id="cb69-31"><a href="#cb69-31" aria-hidden="true" tabindex="-1"></a>                                                  fabric<span class="op">=</span>fabric, </span>
<span id="cb69-32"><a href="#cb69-32" aria-hidden="true" tabindex="-1"></a>                                                  num_classes<span class="op">=</span><span class="bu">len</span>(dataset.classes))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>You are using a CUDA device ('NVIDIA RTX A4000') that has Tensor Cores. To properly utilize them, you should set `torch.set_float32_matmul_precision('medium' | 'high')` which will trade-off precision for performance. For more details, read https://pytorch.org/docs/stable/generated/torch.set_float32_matmul_precision.html#torch.set_float32_matmul_precision
[2023-04-06 07:12:28,856] torch._inductor.utils: [WARNING] using triton random, expect difference from eager</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Dataloaders Length: 118 for a batch size of: 16
Dataloaders Length: 39 for a batch size of: 16
Epoch: [1/3] | train_loss: 2.8451 | train_acc: 0.2013 | train_time: 2.1276 min | test loss: 2.6787 | test_acc: 0.4503 | test_time: 1.0502 min
Epoch: [2/3] | train_loss: 2.5908 | train_acc: 0.4460 | train_time: 1.7023 min | test loss: 2.4270 | test_acc: 0.5481 | test_time: 0.5721 min
Epoch: [3/3] | train_loss: 2.3663 | train_acc: 0.5101 | train_time: 1.5845 min | test loss: 2.2091 | test_acc: 0.5801 | test_time: 0.5688 min

Total Model Training Time: 7.6056 min</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"c302a43170d8409ca2695d3aeb0cc655","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"7c79b1219a6749a49ad870717f636233","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"7012672953204f7dac580391d1be1265","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"84702e0cf8b147c1aec4d2aa8fb442e6","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"b0ac631aa643453da8ef552683d17f11","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"6712147494984591b7d78c3c56147729","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"d5883100cc0d454d9b306bd6c2618727","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
<div class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Saving the result in csv format</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>exp6_results_filename <span class="op">=</span> <span class="st">'exp6_results.csv'</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>exp6_results_df <span class="op">=</span> pd.DataFrame(exp6_results)</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>exp6_results_df.to_csv(os.path.join(RESULTS_DIR, exp6_results_filename), index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>exp6_results_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="42">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">train_acc</th>
<th data-quarto-table-cell-role="th">test_loss</th>
<th data-quarto-table-cell-role="th">test_acc</th>
<th data-quarto-table-cell-role="th">train_epoch_time(min)</th>
<th data-quarto-table-cell-role="th">test_epoch_time(min)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2.845071</td>
<td>0.201271</td>
<td>2.678697</td>
<td>0.450321</td>
<td>2.127585</td>
<td>1.050178</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2.590763</td>
<td>0.445975</td>
<td>2.427013</td>
<td>0.548077</td>
<td>1.702294</td>
<td>0.572100</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2.366281</td>
<td>0.510064</td>
<td>2.209109</td>
<td>0.580128</td>
<td>1.584458</td>
<td>0.568837</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Updating and saving a dataframe for model train time </span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>model_train_time_df.loc[<span class="bu">len</span>(model_train_time_df)] <span class="op">=</span> [<span class="st">'Fabric + Compile'</span>, exp6_total_train_time]</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>model_train_time_df.to_csv(os.path.join(RESULTS_DIR, model_train_time_filename), index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>model_train_time_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="43">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">model</th>
<th data-quarto-table-cell-role="th">training_time(min)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Pytorch Eager</td>
<td>5.794009</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Pytorch Compile</td>
<td>7.790816</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Pytorch Lightning</td>
<td>7.688747</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>PyTorch Lightning + Compile</td>
<td>10.542457</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Fabric Lightning</td>
<td>6.551208</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>Fabric + Compile</td>
<td>7.605610</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="exp-7-fabric-precision" class="level3">
<h3 class="anchored" data-anchor-id="exp-7-fabric-precision">Exp 7: Fabric + Precision</h3>
<div class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>set_seed(<span class="dv">42</span>)</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Initializing Fabric # New by Fabric</span></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>fabric <span class="op">=</span> Fabric(precision<span class="op">=</span><span class="st">'16-mixed'</span>)</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Initializing the model and dataloaders</span></span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>model, transforms <span class="op">=</span> create_model(num_classes<span class="op">=</span><span class="bu">len</span>(dataset.classes), device<span class="op">=</span>fabric.device) <span class="co"># New by Fabric</span></span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a><span class="co"># model.to(device)</span></span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>train_dataloader <span class="op">=</span> create_dataloaders(dataset<span class="op">=</span>train_dataset, batch<span class="op">=</span>BATCH_SIZE, shuffle<span class="op">=</span><span class="va">True</span>, workers<span class="op">=</span>WORKERS)</span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a>test_dataloader <span class="op">=</span> create_dataloaders(dataset<span class="op">=</span>test_dataset, batch<span class="op">=</span>BATCH_SIZE, shuffle<span class="op">=</span><span class="va">False</span>, workers<span class="op">=</span>WORKERS)</span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Intializing loss and optimizer</span></span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a>loss_fn <span class="op">=</span> torch.nn.CrossEntropyLoss()</span>
<span id="cb74-14"><a href="#cb74-14" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> torch.optim.Adam(params<span class="op">=</span>model.parameters(), lr<span class="op">=</span><span class="fl">0.0001</span>)</span>
<span id="cb74-15"><a href="#cb74-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-16"><a href="#cb74-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Fabric setup # New by Fabric</span></span>
<span id="cb74-17"><a href="#cb74-17" aria-hidden="true" tabindex="-1"></a>model, optimizer <span class="op">=</span> fabric.setup(model, optimizer)</span>
<span id="cb74-18"><a href="#cb74-18" aria-hidden="true" tabindex="-1"></a>train_dataloader, test_dataloader <span class="op">=</span> fabric.setup_dataloaders(train_dataloader, test_dataloader)</span>
<span id="cb74-19"><a href="#cb74-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-20"><a href="#cb74-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Training the model using the function</span></span>
<span id="cb74-21"><a href="#cb74-21" aria-hidden="true" tabindex="-1"></a>NUM_EPOCHS <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb74-22"><a href="#cb74-22" aria-hidden="true" tabindex="-1"></a>exp7_results, exp7_total_train_time <span class="op">=</span> model_train(epochs<span class="op">=</span>NUM_EPOCHS,</span>
<span id="cb74-23"><a href="#cb74-23" aria-hidden="true" tabindex="-1"></a>                                                  model<span class="op">=</span>model, </span>
<span id="cb74-24"><a href="#cb74-24" aria-hidden="true" tabindex="-1"></a>                                                  train_dataloader<span class="op">=</span>train_dataloader, </span>
<span id="cb74-25"><a href="#cb74-25" aria-hidden="true" tabindex="-1"></a>                                                  test_dataloader<span class="op">=</span>test_dataloader, </span>
<span id="cb74-26"><a href="#cb74-26" aria-hidden="true" tabindex="-1"></a>                                                  optimizer<span class="op">=</span>optimizer, </span>
<span id="cb74-27"><a href="#cb74-27" aria-hidden="true" tabindex="-1"></a>                                                  loss_fn<span class="op">=</span>loss_fn, </span>
<span id="cb74-28"><a href="#cb74-28" aria-hidden="true" tabindex="-1"></a>                                                  fabric<span class="op">=</span>fabric, </span>
<span id="cb74-29"><a href="#cb74-29" aria-hidden="true" tabindex="-1"></a>                                                  num_classes<span class="op">=</span><span class="bu">len</span>(dataset.classes))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Using 16-bit Automatic Mixed Precision (AMP)
You are using a CUDA device ('NVIDIA RTX A4000') that has Tensor Cores. To properly utilize them, you should set `torch.set_float32_matmul_precision('medium' | 'high')` which will trade-off precision for performance. For more details, read https://pytorch.org/docs/stable/generated/torch.set_float32_matmul_precision.html#torch.set_float32_matmul_precision</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Dataloaders Length: 118 for a batch size of: 16
Dataloaders Length: 39 for a batch size of: 16
Epoch: [1/3] | train_loss: 2.8535 | train_acc: 0.1986 | train_time: 1.5438 min | test loss: 2.6781 | test_acc: 0.4519 | test_time: 0.5552 min
Epoch: [2/3] | train_loss: 2.5991 | train_acc: 0.4168 | train_time: 1.5081 min | test loss: 2.4277 | test_acc: 0.5401 | test_time: 0.5554 min
Epoch: [3/3] | train_loss: 2.3602 | train_acc: 0.5238 | train_time: 1.5786 min | test loss: 2.2094 | test_acc: 0.5817 | test_time: 0.5744 min

Total Model Training Time: 6.3157 min</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"9dac2e0bf9f347f3ad93bbf3b9ad213e","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"0f503931577e4d93b56f178c93e0af2a","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"48d19ea82125417eb0ce839f01021caf","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"f9664f2d32fe406791e5031b8233ebf8","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"f749fcfd196640afa257c06506c4bc27","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"36492b2565a145c1b4b0103b449892fa","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"5174ccb69bdb4c51a52c32108a4b2a66","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
<div class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Saving the result in csv format</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>exp7_results_filename <span class="op">=</span> <span class="st">'exp7_results.csv'</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>exp7_results_df <span class="op">=</span> pd.DataFrame(exp7_results)</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>exp7_results_df.to_csv(os.path.join(RESULTS_DIR, exp7_results_filename), index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>exp7_results_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="45">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">train_acc</th>
<th data-quarto-table-cell-role="th">test_loss</th>
<th data-quarto-table-cell-role="th">test_acc</th>
<th data-quarto-table-cell-role="th">train_epoch_time(min)</th>
<th data-quarto-table-cell-role="th">test_epoch_time(min)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2.853492</td>
<td>0.198623</td>
<td>2.678145</td>
<td>0.451923</td>
<td>1.543753</td>
<td>0.555179</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2.599140</td>
<td>0.416843</td>
<td>2.427695</td>
<td>0.540064</td>
<td>1.508068</td>
<td>0.555399</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2.360222</td>
<td>0.523835</td>
<td>2.209447</td>
<td>0.581731</td>
<td>1.578585</td>
<td>0.574411</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell" data-execution_count="46">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Updating and saving a dataframe for model train time </span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>model_train_time_df.loc[<span class="bu">len</span>(model_train_time_df)] <span class="op">=</span> [<span class="st">'Fabric + Precision'</span>, exp7_total_train_time]</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>model_train_time_df.to_csv(os.path.join(RESULTS_DIR, model_train_time_filename), index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>model_train_time_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="46">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">model</th>
<th data-quarto-table-cell-role="th">training_time(min)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Pytorch Eager</td>
<td>5.794009</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Pytorch Compile</td>
<td>7.790816</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Pytorch Lightning</td>
<td>7.688747</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>PyTorch Lightning + Compile</td>
<td>10.542457</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Fabric Lightning</td>
<td>6.551208</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>Fabric + Compile</td>
<td>7.605610</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>Fabric + Precision</td>
<td>6.315720</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="exp-8-fabric-precision-compile" class="level3">
<h3 class="anchored" data-anchor-id="exp-8-fabric-precision-compile">Exp 8: Fabric + Precision + Compile</h3>
<div class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>set_seed(<span class="dv">42</span>)</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Initializing Fabric # New by Fabric</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>fabric <span class="op">=</span> Fabric(precision<span class="op">=</span><span class="st">'16-mixed'</span>)</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Initializing the model and dataloaders</span></span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>model, transforms <span class="op">=</span> create_model(num_classes<span class="op">=</span><span class="bu">len</span>(dataset.classes), device<span class="op">=</span>fabric.device) <span class="co"># New by Fabric</span></span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a><span class="co"># model.to(device)</span></span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a>train_dataloader <span class="op">=</span> create_dataloaders(dataset<span class="op">=</span>train_dataset, batch<span class="op">=</span>BATCH_SIZE, shuffle<span class="op">=</span><span class="va">True</span>, workers<span class="op">=</span>WORKERS)</span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a>test_dataloader <span class="op">=</span> create_dataloaders(dataset<span class="op">=</span>test_dataset, batch<span class="op">=</span>BATCH_SIZE, shuffle<span class="op">=</span><span class="va">False</span>, workers<span class="op">=</span>WORKERS)</span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Intializing loss and optimizer</span></span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true" tabindex="-1"></a>loss_fn <span class="op">=</span> torch.nn.CrossEntropyLoss()</span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> torch.optim.Adam(params<span class="op">=</span>model.parameters(), lr<span class="op">=</span><span class="fl">0.0001</span>)</span>
<span id="cb79-15"><a href="#cb79-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-16"><a href="#cb79-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Fabric setup # New by Fabric</span></span>
<span id="cb79-17"><a href="#cb79-17" aria-hidden="true" tabindex="-1"></a>model, optimizer <span class="op">=</span> fabric.setup(model, optimizer)</span>
<span id="cb79-18"><a href="#cb79-18" aria-hidden="true" tabindex="-1"></a>train_dataloader, test_dataloader <span class="op">=</span> fabric.setup_dataloaders(train_dataloader, test_dataloader)</span>
<span id="cb79-19"><a href="#cb79-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-20"><a href="#cb79-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Setting up compiled model(Introduced in PyTorch 2.0.0)</span></span>
<span id="cb79-21"><a href="#cb79-21" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> torch.<span class="bu">compile</span>(model, mode<span class="op">=</span><span class="st">'default'</span>)</span>
<span id="cb79-22"><a href="#cb79-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-23"><a href="#cb79-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Training the model using the function</span></span>
<span id="cb79-24"><a href="#cb79-24" aria-hidden="true" tabindex="-1"></a>NUM_EPOCHS <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb79-25"><a href="#cb79-25" aria-hidden="true" tabindex="-1"></a>exp8_results, exp8_total_train_time <span class="op">=</span> model_train(epochs<span class="op">=</span>NUM_EPOCHS,</span>
<span id="cb79-26"><a href="#cb79-26" aria-hidden="true" tabindex="-1"></a>                                                  model<span class="op">=</span>model, </span>
<span id="cb79-27"><a href="#cb79-27" aria-hidden="true" tabindex="-1"></a>                                                  train_dataloader<span class="op">=</span>train_dataloader, </span>
<span id="cb79-28"><a href="#cb79-28" aria-hidden="true" tabindex="-1"></a>                                                  test_dataloader<span class="op">=</span>test_dataloader, </span>
<span id="cb79-29"><a href="#cb79-29" aria-hidden="true" tabindex="-1"></a>                                                  optimizer<span class="op">=</span>optimizer, </span>
<span id="cb79-30"><a href="#cb79-30" aria-hidden="true" tabindex="-1"></a>                                                  loss_fn<span class="op">=</span>loss_fn, </span>
<span id="cb79-31"><a href="#cb79-31" aria-hidden="true" tabindex="-1"></a>                                                  fabric<span class="op">=</span>fabric, </span>
<span id="cb79-32"><a href="#cb79-32" aria-hidden="true" tabindex="-1"></a>                                                  num_classes<span class="op">=</span><span class="bu">len</span>(dataset.classes))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Using 16-bit Automatic Mixed Precision (AMP)
You are using a CUDA device ('NVIDIA RTX A4000') that has Tensor Cores. To properly utilize them, you should set `torch.set_float32_matmul_precision('medium' | 'high')` which will trade-off precision for performance. For more details, read https://pytorch.org/docs/stable/generated/torch.set_float32_matmul_precision.html#torch.set_float32_matmul_precision
[2023-04-06 07:26:29,375] torch._inductor.utils: [WARNING] using triton random, expect difference from eager</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Dataloaders Length: 118 for a batch size of: 16
Dataloaders Length: 39 for a batch size of: 16
Epoch: [1/3] | train_loss: 2.8451 | train_acc: 0.2013 | train_time: 3.0326 min | test loss: 2.6787 | test_acc: 0.4503 | test_time: 1.1394 min
Epoch: [2/3] | train_loss: 2.5908 | train_acc: 0.4460 | train_time: 1.5740 min | test loss: 2.4270 | test_acc: 0.5481 | test_time: 0.5764 min
Epoch: [3/3] | train_loss: 2.3663 | train_acc: 0.5095 | train_time: 1.5562 min | test loss: 2.2091 | test_acc: 0.5801 | test_time: 0.5639 min

Total Model Training Time: 8.4427 min</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"d9cebc95d30847ce99dea654fbec4dc9","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"d2d7fc47629449b798f4bbce62df57af","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"6128e7bf4e364206801bf3a66ec2986b","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"4164b2bf40d04461b5ed7833e0f9fade","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"47774e3778a441a284da7b91658388db","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"7724e3ab270442529be4f4121334f980","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"1e0d63bc660d4012bf5ffc6342c4f6e9","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
<div class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Saving the result in csv format</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>exp8_results_filename <span class="op">=</span> <span class="st">'exp8_results.csv'</span></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>exp8_results_df <span class="op">=</span> pd.DataFrame(exp8_results)</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>exp8_results_df.to_csv(os.path.join(RESULTS_DIR, exp8_results_filename), index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>exp8_results_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="48">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">train_acc</th>
<th data-quarto-table-cell-role="th">test_loss</th>
<th data-quarto-table-cell-role="th">test_acc</th>
<th data-quarto-table-cell-role="th">train_epoch_time(min)</th>
<th data-quarto-table-cell-role="th">test_epoch_time(min)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2.845062</td>
<td>0.201271</td>
<td>2.678693</td>
<td>0.450321</td>
<td>3.032648</td>
<td>1.139419</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2.590762</td>
<td>0.445975</td>
<td>2.427031</td>
<td>0.548077</td>
<td>1.574046</td>
<td>0.576357</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2.366282</td>
<td>0.509534</td>
<td>2.209138</td>
<td>0.580128</td>
<td>1.556243</td>
<td>0.563871</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Updating and saving a dataframe for model train time </span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>model_train_time_df.loc[<span class="bu">len</span>(model_train_time_df)] <span class="op">=</span> [<span class="st">'Fabric + Precision + Compile'</span>, exp8_total_train_time]</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>model_train_time_df.to_csv(os.path.join(RESULTS_DIR, model_train_time_filename), index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>model_train_time_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="49">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">model</th>
<th data-quarto-table-cell-role="th">training_time(min)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Pytorch Eager</td>
<td>5.794009</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Pytorch Compile</td>
<td>7.790816</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Pytorch Lightning</td>
<td>7.688747</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>PyTorch Lightning + Compile</td>
<td>10.542457</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Fabric Lightning</td>
<td>6.551208</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>Fabric + Compile</td>
<td>7.605610</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>Fabric + Precision</td>
<td>6.315720</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>Fabric + Precision + Compile</td>
<td>8.442741</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell" data-execution_count="50">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot the train time</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>model_train_time_df.plot.barh(x<span class="op">=</span><span class="st">'model'</span>, </span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>                              y<span class="op">=</span><span class="st">'training_time(min)'</span>, </span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>                              xlabel<span class="op">=</span><span class="st">'Training Time(min)'</span>, </span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>                              ylabel<span class="op">=</span><span class="st">'Training Method'</span>, </span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>                              legend<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="ss">f'MVit V2 Model Training Time for </span><span class="sc">{</span>NUM_EPOCHS<span class="sc">}</span><span class="ss"> Epochs'</span>)</span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a>plt.savefig(<span class="st">'model_train_time.png'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="HMDB51_human_action_recognition_pytorch_files/figure-html/cell-51-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
</section>
<section id="training-and-testing-on-full-dataset-and-deploying-the-model" class="level2">
<h2 class="anchored" data-anchor-id="training-and-testing-on-full-dataset-and-deploying-the-model">Training and Testing on Full Dataset and Deploying the Model</h2>
<section id="creating-the-model" class="level3">
<h3 class="anchored" data-anchor-id="creating-the-model">Creating the model</h3>
<div class="cell" data-execution_count="51">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>NUM_CLASSES <span class="op">=</span> <span class="dv">51</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>SEQUENCE_LENGTH <span class="op">=</span> <span class="dv">16</span></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>BATCH_SIZE <span class="op">=</span> <span class="dv">16</span></span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>WORKERS <span class="op">=</span> os.cpu_count()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="52">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating the model and transforms using the function.</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>model, transforms <span class="op">=</span> create_model(num_classes<span class="op">=</span>NUM_CLASSES, device<span class="op">=</span>device)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="getting-the-full-dataset-and-dataloaders" class="level3">
<h3 class="anchored" data-anchor-id="getting-the-full-dataset-and-dataloaders">Getting the Full Dataset and Dataloaders</h3>
<div class="cell" data-execution_count="53">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating the dataset.</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>dataset <span class="op">=</span> HumanActionDataset(video_dir<span class="op">=</span>DATA_PATH, </span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>                             seq_len<span class="op">=</span>SEQUENCE_LENGTH,</span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>                             num_classes<span class="op">=</span>NUM_CLASSES,</span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>                             transform<span class="op">=</span>transforms)</span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>train_dataset, test_dataset <span class="op">=</span> random_split(dataset<span class="op">=</span>dataset,</span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a>                                           lengths<span class="op">=</span>[<span class="fl">0.75</span>, <span class="fl">0.25</span>], </span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a>                                           generator<span class="op">=</span>torch.Generator().manual_seed(<span class="dv">42</span>))</span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Train Dataset Length: </span><span class="sc">{</span><span class="bu">len</span>(train_dataset)<span class="sc">}</span><span class="ss"> and Test Dataset length: </span><span class="sc">{</span><span class="bu">len</span>(test_dataset)<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-11"><a href="#cb87-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating the dataloaders</span></span>
<span id="cb87-12"><a href="#cb87-12" aria-hidden="true" tabindex="-1"></a>train_dataloader <span class="op">=</span> create_dataloaders(dataset<span class="op">=</span>train_dataset, batch<span class="op">=</span>BATCH_SIZE, shuffle<span class="op">=</span><span class="va">True</span>, workers<span class="op">=</span>WORKERS)</span>
<span id="cb87-13"><a href="#cb87-13" aria-hidden="true" tabindex="-1"></a>test_dataloader <span class="op">=</span> create_dataloaders(dataset<span class="op">=</span>test_dataset, batch<span class="op">=</span>BATCH_SIZE, shuffle<span class="op">=</span><span class="va">False</span>, workers<span class="op">=</span>WORKERS)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Train Dataset Length: 5075 and Test Dataset length: 1691
Dataloaders Length: 317 for a batch size of: 16
Dataloaders Length: 105 for a batch size of: 16</code></pre>
</div>
</div>
</section>
<section id="training-model-for-full-dataset" class="level3">
<h3 class="anchored" data-anchor-id="training-model-for-full-dataset">Training Model for Full Dataset</h3>
<div class="cell" data-execution_count="55">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>set_seed(<span class="dv">42</span>)</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Intializing loss and optimizer</span></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>loss_fn <span class="op">=</span> torch.nn.CrossEntropyLoss(label_smoothing<span class="op">=</span><span class="fl">0.1</span>)</span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> torch.optim.Adam(params<span class="op">=</span>model.parameters(), lr<span class="op">=</span><span class="fl">0.001</span>)</span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Training the model using the pytorch function </span></span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a>NUM_EPOCHS <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a>results, total_train_time <span class="op">=</span> model_train(epochs<span class="op">=</span>NUM_EPOCHS,</span>
<span id="cb89-10"><a href="#cb89-10" aria-hidden="true" tabindex="-1"></a>                                        model<span class="op">=</span>model, </span>
<span id="cb89-11"><a href="#cb89-11" aria-hidden="true" tabindex="-1"></a>                                        train_dataloader<span class="op">=</span>train_dataloader, </span>
<span id="cb89-12"><a href="#cb89-12" aria-hidden="true" tabindex="-1"></a>                                        test_dataloader<span class="op">=</span>test_dataloader, </span>
<span id="cb89-13"><a href="#cb89-13" aria-hidden="true" tabindex="-1"></a>                                        optimizer<span class="op">=</span>optimizer, </span>
<span id="cb89-14"><a href="#cb89-14" aria-hidden="true" tabindex="-1"></a>                                        loss_fn<span class="op">=</span>loss_fn, </span>
<span id="cb89-15"><a href="#cb89-15" aria-hidden="true" tabindex="-1"></a>                                        device<span class="op">=</span>device, </span>
<span id="cb89-16"><a href="#cb89-16" aria-hidden="true" tabindex="-1"></a>                                        num_classes<span class="op">=</span><span class="bu">len</span>(dataset.classes))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"5db43b3340dc49a393da04ed9c46d459","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"1dbb13e51d0948aab363cf5a8971ae9c","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"c0489dc6c4c54d30a457db316060526d","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch: [1/10] | train_loss: 2.6020 | train_acc: 0.4720 | train_time: 4.8366 min | test loss: 1.8906 | test_acc: 0.6238 | test_time: 1.6950 min
Epoch: [2/10] | train_loss: 1.8662 | train_acc: 0.6327 | train_time: 5.4221 min | test loss: 1.7076 | test_acc: 0.6607 | test_time: 1.5391 min
Epoch: [3/10] | train_loss: 1.7319 | train_acc: 0.6642 | train_time: 4.8773 min | test loss: 1.6484 | test_acc: 0.6756 | test_time: 1.5405 min
Epoch: [4/10] | train_loss: 1.6819 | train_acc: 0.6733 | train_time: 4.5695 min | test loss: 1.6199 | test_acc: 0.6887 | test_time: 1.5152 min
Epoch: [5/10] | train_loss: 1.6426 | train_acc: 0.6936 | train_time: 4.3718 min | test loss: 1.6051 | test_acc: 0.6970 | test_time: 1.5019 min
Epoch: [6/10] | train_loss: 1.6085 | train_acc: 0.6981 | train_time: 4.7581 min | test loss: 1.5919 | test_acc: 0.7000 | test_time: 1.5833 min
Epoch: [7/10] | train_loss: 1.5967 | train_acc: 0.7049 | train_time: 4.9686 min | test loss: 1.5807 | test_acc: 0.7071 | test_time: 1.5994 min
Epoch: [8/10] | train_loss: 1.5680 | train_acc: 0.7173 | train_time: 6.3247 min | test loss: 1.5763 | test_acc: 0.7137 | test_time: 1.5196 min
Epoch: [9/10] | train_loss: 1.5577 | train_acc: 0.7179 | train_time: 5.6291 min | test loss: 1.5734 | test_acc: 0.7083 | test_time: 1.5351 min
Epoch: [10/10] | train_loss: 1.5540 | train_acc: 0.7194 | train_time: 5.6172 min | test loss: 1.5605 | test_acc: 0.7185 | test_time: 1.5643 min

Total Model Training Time: 66.9688 min</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"074c47d5bea242038a9c3882bdec2763","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"f2d901254d5d42519adbe15d59abbd52","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"5081ba8cdcfe4dafbdb6a82ce9d512ae","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"00718ac5f3bc498d9368c5b59a649dd9","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"561a491d2281414fb5fe3ad325d7107a","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"66d064e24c77453d8b20ec8198d843df","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"805233dce7e14d85a4e30a013d6f8203","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"8532ddeee23a4ec68598707fd2e6b378","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"68a02b29fb694ba19c0d42194c5dbc00","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"1b657e9189534f1e82d268a8fe34975d","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"efe00694d77e48bc9d3110b68d3688c1","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"cb20e196dfed4ed3a33e61af82f7f178","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"388d7a11dec941b0b169e947d8f3d6af","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"b34e06cafbc144dd975854c9e3df9623","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"6ef90099d54f4c9db28cc185e35e3b42","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"bd1f020b3344499ea54bacf1bca6ce93","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"e5df60c7a00f489487007d6aaeac7f1d","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"bb7b7955f0574507ab03142177fb8d17","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
</section>
<section id="storing-files-for-demo-app." class="level3">
<h3 class="anchored" data-anchor-id="storing-files-for-demo-app.">Storing Files for Demo App.</h3>
<div class="cell" data-execution_count="56">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating a directory for the app</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>demo_path <span class="op">=</span> <span class="st">'demo'</span></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>demo_project_path <span class="op">=</span> os.path.join(demo_path, <span class="st">'human_action_recognition'</span>)</span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>demo_example_path <span class="op">=</span> os.path.join(demo_project_path, <span class="st">'examples'</span>)</span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> os.path.exists(demo_path):</span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'[INFO] "</span><span class="sc">{</span>demo_path<span class="sc">}</span><span class="ss">" already exists.'</span>)</span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a>    os.mkdir(demo_path)</span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a>    os.mkdir(demo_project_path)</span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a>    os.mkdir(demo_example_path)</span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'[INFO] "</span><span class="sc">{</span>demo_project_path<span class="sc">}</span><span class="ss">" and "</span><span class="sc">{</span>demo_example_path<span class="sc">}</span><span class="ss">" directory is been created.'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[INFO] "demo/human_action_recognition" and "demo/human_action_recognition/examples" directory is been created.</code></pre>
</div>
</div>
<div class="cell" data-execution_count="57">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Saving some example files</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>example_files <span class="op">=</span> [<span class="st">'data/shoot_bow/6arrowswithin30seconds_shoot_bow_f_nm_np1_fr_med_3.avi'</span>,</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>                 <span class="st">'data/golf/Golf_Tips_-_Hit_The_Driver_300+_Yards!!!_golf_f_nm_np1_fr_med_0.avi'</span>,</span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>                 <span class="st">'data/climb/(HQ)_Rock_Climbing_-_Free_Solo_Speed_Climb_-_Dan_Osman_climb_f_cm_np1_le_med_2.avi'</span>,</span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a>                 <span class="st">'data/punch/AdvancedBoxingTechniquesandExercises_punch_u_nm_np1_ba_med_23.avi'</span>,</span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a>                 <span class="st">'data/swing_baseball/BaseballHitinSlowMotion_swing_baseball_f_nm_np1_fr_bad_0.avi'</span>]</span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> example_files:</span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Copying the files</span></span>
<span id="cb93-10"><a href="#cb93-10" aria-hidden="true" tabindex="-1"></a>    shutil.copy2(src<span class="op">=</span>i, dst<span class="op">=</span><span class="st">'demo/human_action_recognition/examples'</span>)</span>
<span id="cb93-11"><a href="#cb93-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss"> File is been copied.'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>data/shoot_bow/6arrowswithin30seconds_shoot_bow_f_nm_np1_fr_med_3.avi File is been copied.
data/golf/Golf_Tips_-_Hit_The_Driver_300+_Yards!!!_golf_f_nm_np1_fr_med_0.avi File is been copied.
data/climb/(HQ)_Rock_Climbing_-_Free_Solo_Speed_Climb_-_Dan_Osman_climb_f_cm_np1_le_med_2.avi File is been copied.
data/punch/AdvancedBoxingTechniquesandExercises_punch_u_nm_np1_ba_med_23.avi File is been copied.
data/swing_baseball/BaseballHitinSlowMotion_swing_baseball_f_nm_np1_fr_bad_0.avi File is been copied.</code></pre>
</div>
</div>
<div class="cell" data-execution_count="58">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Saving the classes names to text file</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>class_names_path <span class="op">=</span> os.path.join(demo_project_path, <span class="st">'class_names.txt'</span>)</span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(class_names_path, <span class="st">'w'</span>) <span class="im">as</span> f:</span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a>    f.write(<span class="st">'</span><span class="ch">\n</span><span class="st">'</span>.join(dataset.classes))</span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'[INFO] Saving class names to: "</span><span class="sc">{</span>class_names_path<span class="sc">}</span><span class="ss">"'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[INFO] Saving class names to: "demo/human_action_recognition/class_names.txt"</code></pre>
</div>
</div>
<div class="cell" data-execution_count="59">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Reading the text file</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(class_names_path, <span class="st">'r'</span>) <span class="im">as</span> f:</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>    class_names_read <span class="op">=</span> [i.strip() <span class="cf">for</span> i <span class="kw">in</span> f.readlines()]</span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>class_names_read[:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="59">
<pre><code>['smoke', 'dive', 'cartwheel', 'throw', 'hit']</code></pre>
</div>
</div>
</section>
<section id="saving-and-loading-the-model" class="level3">
<h3 class="anchored" data-anchor-id="saving-and-loading-the-model">Saving and Loading the Model</h3>
<div class="cell" data-execution_count="60">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>model_save_name <span class="op">=</span> <span class="st">'mvit_v2_pretrained_model_hmdb51.pth'</span></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>model_save_path <span class="op">=</span> os.path.join(demo_project_path, model_save_name)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="61">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="co"># saving the model state</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>torch.save(obj<span class="op">=</span>model.state_dict(), </span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>           f<span class="op">=</span>model_save_path)</span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'[INFO] Model is been saved to: "</span><span class="sc">{</span>model_save_path<span class="sc">}</span><span class="ss">"'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[INFO] Model is been saved to: "demo/human_action_recognition/mvit_v2_pretrained_model_hmdb51.pth"</code></pre>
</div>
</div>
<div class="cell" data-execution_count="62">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="co"># loading the model state</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>model, transforms <span class="op">=</span> create_model(num_classes<span class="op">=</span>NUM_CLASSES, device<span class="op">=</span>device)</span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>model.load_state_dict(torch.load(model_save_path))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="62">
<pre><code>&lt;All keys matched successfully&gt;</code></pre>
</div>
</div>
</section>
<section id="creating-a-text-file-for-modules-and-packages" class="level3">
<h3 class="anchored" data-anchor-id="creating-a-text-file-for-modules-and-packages">Creating a text file for Modules and Packages</h3>
<div class="cell" data-execution_count="63">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile demo<span class="op">/</span>human_action_recognition<span class="op">/</span>requirements.txt</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>av<span class="op">==</span><span class="fl">10.0.0</span></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>torch<span class="op">==</span><span class="fl">2.0.0</span></span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>torchvision<span class="op">==</span><span class="fl">0.15.1</span></span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>torchaudio<span class="op">==</span><span class="fl">2.0.1</span></span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>gradio<span class="op">==</span><span class="fl">3.24.1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Writing demo/human_action_recognition/requirements.txt</code></pre>
</div>
</div>
</section>
<section id="creating-a-python-script-to-preprocess-the-data" class="level3">
<h3 class="anchored" data-anchor-id="creating-a-python-script-to-preprocess-the-data">Creating a Python Script to Preprocess the Data</h3>
<div class="cell" data-execution_count="64">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile demo<span class="op">/</span>human_action_recognition<span class="op">/</span>utils.py</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torchvision</span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> preprocess_video(video: <span class="bu">str</span>):</span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a><span class="co">    A function to preprocess the video file before going into the model.</span></span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters: </span></span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a><span class="co">        video: str, A string for the video file path.</span></span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns: selected_frame: torch.Tensor, A tensor of shape 'TCHW'.</span></span>
<span id="cb106-11"><a href="#cb106-11" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb106-12"><a href="#cb106-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Reading the video file</span></span>
<span id="cb106-13"><a href="#cb106-13" aria-hidden="true" tabindex="-1"></a>    vframes, _, _ <span class="op">=</span> torchvision.io.read_video(filename<span class="op">=</span>video, pts_unit<span class="op">=</span><span class="st">'sec'</span>, output_format<span class="op">=</span><span class="st">'TCHW'</span>)</span>
<span id="cb106-14"><a href="#cb106-14" aria-hidden="true" tabindex="-1"></a>    vframes <span class="op">=</span> vframes.<span class="bu">type</span>(torch.float32)</span>
<span id="cb106-15"><a href="#cb106-15" aria-hidden="true" tabindex="-1"></a>    vframes_count <span class="op">=</span> <span class="bu">len</span>(vframes)</span>
<span id="cb106-16"><a href="#cb106-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb106-17"><a href="#cb106-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Selecting frames at certain interval</span></span>
<span id="cb106-18"><a href="#cb106-18" aria-hidden="true" tabindex="-1"></a>    skip_frames <span class="op">=</span> <span class="bu">max</span>(<span class="bu">int</span>(vframes_count<span class="op">/</span><span class="dv">16</span>), <span class="dv">1</span>)</span>
<span id="cb106-19"><a href="#cb106-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb106-20"><a href="#cb106-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Selecting the first frame</span></span>
<span id="cb106-21"><a href="#cb106-21" aria-hidden="true" tabindex="-1"></a>    selected_frame <span class="op">=</span> vframes[<span class="dv">0</span>].unsqueeze(<span class="dv">0</span>)</span>
<span id="cb106-22"><a href="#cb106-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb106-23"><a href="#cb106-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Creating a new sequence of frames upto the defined sequence length.</span></span>
<span id="cb106-24"><a href="#cb106-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">16</span>):</span>
<span id="cb106-25"><a href="#cb106-25" aria-hidden="true" tabindex="-1"></a>        selected_frame <span class="op">=</span> torch.concat((selected_frame, vframes[i <span class="op">*</span> skip_frames].unsqueeze(<span class="dv">0</span>)))</span>
<span id="cb106-26"><a href="#cb106-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> selected_frame</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Writing demo/human_action_recognition/utils.py</code></pre>
</div>
</div>
</section>
<section id="creating-a-python-script-to-create-the-model" class="level3">
<h3 class="anchored" data-anchor-id="creating-a-python-script-to-create-the-model">Creating a Python Script to Create the Model</h3>
<div class="cell" data-execution_count="65">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile demo<span class="op">/</span>human_action_recognition<span class="op">/</span>model.py</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torchvision</span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_model(num_classes: <span class="bu">int</span>, seed: <span class="bu">int</span> <span class="op">=</span> <span class="dv">42</span>):</span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a><span class="co">    A function to create a model.</span></span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb108-9"><a href="#cb108-9" aria-hidden="true" tabindex="-1"></a><span class="co">        num_classes: int, A integer for toal number of classes.</span></span>
<span id="cb108-10"><a href="#cb108-10" aria-hidden="true" tabindex="-1"></a><span class="co">        seed: int(default: 42), A random seed value.</span></span>
<span id="cb108-11"><a href="#cb108-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns: </span></span>
<span id="cb108-12"><a href="#cb108-12" aria-hidden="true" tabindex="-1"></a><span class="co">        model: A feature extracted model for video classification.</span></span>
<span id="cb108-13"><a href="#cb108-13" aria-hidden="true" tabindex="-1"></a><span class="co">        transforms: A torchvision transform is returned which was used in the pretrained model.    </span></span>
<span id="cb108-14"><a href="#cb108-14" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb108-15"><a href="#cb108-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Creating model, weights and transforms</span></span>
<span id="cb108-16"><a href="#cb108-16" aria-hidden="true" tabindex="-1"></a>    weights <span class="op">=</span> torchvision.models.video.MViT_V2_S_Weights.DEFAULT</span>
<span id="cb108-17"><a href="#cb108-17" aria-hidden="true" tabindex="-1"></a>    transforms <span class="op">=</span> weights.transforms()</span>
<span id="cb108-18"><a href="#cb108-18" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> torchvision.models.video.mvit_v2_s(weights<span class="op">=</span>weights)</span>
<span id="cb108-19"><a href="#cb108-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb108-20"><a href="#cb108-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Freezing the model layers</span></span>
<span id="cb108-21"><a href="#cb108-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> params <span class="kw">in</span> model.parameters():</span>
<span id="cb108-22"><a href="#cb108-22" aria-hidden="true" tabindex="-1"></a>        params.requires_grad <span class="op">=</span> <span class="va">False</span></span>
<span id="cb108-23"><a href="#cb108-23" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb108-24"><a href="#cb108-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Changing the fully Conncected head layer</span></span>
<span id="cb108-25"><a href="#cb108-25" aria-hidden="true" tabindex="-1"></a>    torch.manual_seed(seed)</span>
<span id="cb108-26"><a href="#cb108-26" aria-hidden="true" tabindex="-1"></a>    dropout_layer <span class="op">=</span> model.head[<span class="dv">0</span>]</span>
<span id="cb108-27"><a href="#cb108-27" aria-hidden="true" tabindex="-1"></a>    in_features <span class="op">=</span> model.head[<span class="dv">1</span>].in_features</span>
<span id="cb108-28"><a href="#cb108-28" aria-hidden="true" tabindex="-1"></a>    model.head <span class="op">=</span> torch.nn.Sequential(</span>
<span id="cb108-29"><a href="#cb108-29" aria-hidden="true" tabindex="-1"></a>        dropout_layer,</span>
<span id="cb108-30"><a href="#cb108-30" aria-hidden="true" tabindex="-1"></a>        torch.nn.Linear(in_features<span class="op">=</span>in_features, out_features<span class="op">=</span>num_classes, bias<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb108-31"><a href="#cb108-31" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb108-32"><a href="#cb108-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> model, transforms</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Writing demo/human_action_recognition/model.py</code></pre>
</div>
</div>
</section>
<section id="creating-a-python-script-for-gradio-app" class="level3">
<h3 class="anchored" data-anchor-id="creating-a-python-script-for-gradio-app">Creating a Python Script for Gradio App</h3>
<div class="cell" data-execution_count="66">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile demo<span class="op">/</span>human_action_recognition<span class="op">/</span>app.py</span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> gradio <span class="im">as</span> gr</span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torchvision</span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> timeit <span class="im">import</span> default_timer <span class="im">as</span> timer</span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> model <span class="im">import</span> create_model</span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> utils <span class="im">import</span> preprocess_video</span>
<span id="cb110-9"><a href="#cb110-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-10"><a href="#cb110-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Configuring the device</span></span>
<span id="cb110-11"><a href="#cb110-11" aria-hidden="true" tabindex="-1"></a>device <span class="op">=</span> torch.device(<span class="st">'cuda'</span> <span class="cf">if</span> torch.cuda.is_available() <span class="cf">else</span> <span class="st">'cpu'</span>)</span>
<span id="cb110-12"><a href="#cb110-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-13"><a href="#cb110-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Setting class names using the text file</span></span>
<span id="cb110-14"><a href="#cb110-14" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'class_names.txt'</span>, <span class="st">'r'</span>) <span class="im">as</span> f:</span>
<span id="cb110-15"><a href="#cb110-15" aria-hidden="true" tabindex="-1"></a>    class_names <span class="op">=</span> [i.strip() <span class="cf">for</span> i <span class="kw">in</span> f.readlines()]</span>
<span id="cb110-16"><a href="#cb110-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-17"><a href="#cb110-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Setting the model and transforms</span></span>
<span id="cb110-18"><a href="#cb110-18" aria-hidden="true" tabindex="-1"></a>model, transforms <span class="op">=</span> create_model(num_classes<span class="op">=</span><span class="bu">len</span>(class_names), seed<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb110-19"><a href="#cb110-19" aria-hidden="true" tabindex="-1"></a>model.load_state_dict(torch.load(f<span class="op">=</span><span class="st">'mvit_v2_pretrained_model_hmdb51.pth'</span>, map_location<span class="op">=</span>device))</span>
<span id="cb110-20"><a href="#cb110-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-21"><a href="#cb110-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating a function to predict the video</span></span>
<span id="cb110-22"><a href="#cb110-22" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> predict(video_file):</span>
<span id="cb110-23"><a href="#cb110-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb110-24"><a href="#cb110-24" aria-hidden="true" tabindex="-1"></a><span class="co">    A function to predict the video using the model.</span></span>
<span id="cb110-25"><a href="#cb110-25" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters: </span></span>
<span id="cb110-26"><a href="#cb110-26" aria-hidden="true" tabindex="-1"></a><span class="co">        video_file: str, A video file path as a string.</span></span>
<span id="cb110-27"><a href="#cb110-27" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns: </span></span>
<span id="cb110-28"><a href="#cb110-28" aria-hidden="true" tabindex="-1"></a><span class="co">        pred_labels_probs: A dict file containing the class names and confidence values.</span></span>
<span id="cb110-29"><a href="#cb110-29" aria-hidden="true" tabindex="-1"></a><span class="co">        pred_time: Time taken to predict in seconds.</span></span>
<span id="cb110-30"><a href="#cb110-30" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb110-31"><a href="#cb110-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Preprocessing the video file</span></span>
<span id="cb110-32"><a href="#cb110-32" aria-hidden="true" tabindex="-1"></a>    frames <span class="op">=</span> preprocess_video(video<span class="op">=</span>video_file)</span>
<span id="cb110-33"><a href="#cb110-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb110-34"><a href="#cb110-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># transforming the frames</span></span>
<span id="cb110-35"><a href="#cb110-35" aria-hidden="true" tabindex="-1"></a>    mod_frames <span class="op">=</span> transforms(frames).unsqueeze(dim<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb110-36"><a href="#cb110-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb110-37"><a href="#cb110-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Starting the timer and predicting using the model</span></span>
<span id="cb110-38"><a href="#cb110-38" aria-hidden="true" tabindex="-1"></a>    start_time <span class="op">=</span> timer()</span>
<span id="cb110-39"><a href="#cb110-39" aria-hidden="true" tabindex="-1"></a>    model.<span class="bu">eval</span>()</span>
<span id="cb110-40"><a href="#cb110-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb110-41"><a href="#cb110-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># forward pass</span></span>
<span id="cb110-42"><a href="#cb110-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> torch.no_grad():</span>
<span id="cb110-43"><a href="#cb110-43" aria-hidden="true" tabindex="-1"></a>        logits <span class="op">=</span> model(mod_frames.to(device)) </span>
<span id="cb110-44"><a href="#cb110-44" aria-hidden="true" tabindex="-1"></a>        pred_probs <span class="op">=</span> torch.softmax(logits, dim<span class="op">=</span><span class="dv">1</span>).squeeze(dim<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb110-45"><a href="#cb110-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb110-46"><a href="#cb110-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Creating a dict with class names and their predicted probabilities</span></span>
<span id="cb110-47"><a href="#cb110-47" aria-hidden="true" tabindex="-1"></a>    pred_labels_probs <span class="op">=</span> {class_names[i]: <span class="bu">float</span>(pred_probs[i]) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(class_names))}</span>
<span id="cb110-48"><a href="#cb110-48" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb110-49"><a href="#cb110-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ending the timer and calculating the prediction time.</span></span>
<span id="cb110-50"><a href="#cb110-50" aria-hidden="true" tabindex="-1"></a>    end_time <span class="op">=</span> timer()</span>
<span id="cb110-51"><a href="#cb110-51" aria-hidden="true" tabindex="-1"></a>    pred_time <span class="op">=</span> <span class="bu">round</span>(end_time <span class="op">-</span> start_time, <span class="dv">5</span>)</span>
<span id="cb110-52"><a href="#cb110-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb110-53"><a href="#cb110-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Returning the labels and time for gradio output.</span></span>
<span id="cb110-54"><a href="#cb110-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pred_labels_probs, pred_time</span>
<span id="cb110-55"><a href="#cb110-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-56"><a href="#cb110-56" aria-hidden="true" tabindex="-1"></a><span class="co"># Pre-information for interface</span></span>
<span id="cb110-57"><a href="#cb110-57" aria-hidden="true" tabindex="-1"></a>title <span class="op">=</span> <span class="st">'Human Activity Recognition(HAR)'</span></span>
<span id="cb110-58"><a href="#cb110-58" aria-hidden="true" tabindex="-1"></a>description <span class="op">=</span> <span class="st">'A Gradio demo web application for video classification using the MViT V2 Pretrained Model and trained on the HMDB51 Dataset.'</span></span>
<span id="cb110-59"><a href="#cb110-59" aria-hidden="true" tabindex="-1"></a>article <span class="op">=</span> <span class="st">'Created by John'</span></span>
<span id="cb110-60"><a href="#cb110-60" aria-hidden="true" tabindex="-1"></a>example_list <span class="op">=</span> [[<span class="st">'examples/'</span><span class="op">+</span> i] <span class="cf">for</span> i <span class="kw">in</span> os.listdir(<span class="st">'examples'</span>)]</span>
<span id="cb110-61"><a href="#cb110-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-62"><a href="#cb110-62" aria-hidden="true" tabindex="-1"></a><span class="co"># Building the Gradio interface</span></span>
<span id="cb110-63"><a href="#cb110-63" aria-hidden="true" tabindex="-1"></a>demo <span class="op">=</span> gr.Interface(fn<span class="op">=</span>predict,</span>
<span id="cb110-64"><a href="#cb110-64" aria-hidden="true" tabindex="-1"></a>                    inputs<span class="op">=</span>gr.Video(label<span class="op">=</span><span class="st">'Video'</span>),</span>
<span id="cb110-65"><a href="#cb110-65" aria-hidden="true" tabindex="-1"></a>                    outputs<span class="op">=</span>[gr.Label(num_top_classes<span class="op">=</span><span class="dv">5</span>, label<span class="op">=</span><span class="st">'Predictions'</span>),</span>
<span id="cb110-66"><a href="#cb110-66" aria-hidden="true" tabindex="-1"></a>                             gr.Number(label<span class="op">=</span><span class="st">'Prediction Time (sec)'</span>)],</span>
<span id="cb110-67"><a href="#cb110-67" aria-hidden="true" tabindex="-1"></a>                    examples<span class="op">=</span>example_list,</span>
<span id="cb110-68"><a href="#cb110-68" aria-hidden="true" tabindex="-1"></a>                    title<span class="op">=</span>title,</span>
<span id="cb110-69"><a href="#cb110-69" aria-hidden="true" tabindex="-1"></a>                    description<span class="op">=</span>description,</span>
<span id="cb110-70"><a href="#cb110-70" aria-hidden="true" tabindex="-1"></a>                    article<span class="op">=</span>article)</span>
<span id="cb110-71"><a href="#cb110-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-72"><a href="#cb110-72" aria-hidden="true" tabindex="-1"></a><span class="co"># Launching the gradio interface</span></span>
<span id="cb110-73"><a href="#cb110-73" aria-hidden="true" tabindex="-1"></a>demo.launch()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Writing demo/human_action_recognition/app.py</code></pre>
</div>
</div>
</section>
<section id="deploying-on-huggingface" class="level3">
<h3 class="anchored" data-anchor-id="deploying-on-huggingface">Deploying on HuggingFace</h3>
<div class="cell" data-execution_count="67">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>IFrame(src<span class="op">=</span><span class="st">'https://hf.space/embed/JohnPinto/Human_Activity_Recognition-HAR-Video_Classification-HMDB51-Dataset'</span>,</span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>       width<span class="op">=</span><span class="dv">1050</span>,</span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>       height<span class="op">=</span><span class="dv">700</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="67">

        <iframe width="1050" height="700" src="https://hf.space/embed/JohnPinto/Human_Activity_Recognition-HAR-Video_Classification-HMDB51-Dataset" frameborder="0" allowfullscreen=""></iframe>
        
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">John Pinto <i class="fa-copyright fa-regular" aria-label="regular"></i> 2023 made with HTML5 <i class="fab fa-html5"></i>, CSS3 <i class="fa-brands fa-css3"></i> and <a href="https://quarto.org">Quarto</a>.</div>   
    <div class="nav-footer-center"><div class="cookie-consent-footer"><a href="#" id="open_preferences_center">Cookie Preferences</a></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>



</body></html>